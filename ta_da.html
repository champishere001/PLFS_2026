<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TA/DA Calculation Sheet (Auto + PDF + Excel)</title>

<!-- PDF + Excel libs (NO PRINT) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --border:#000;
    --bg:#f2f4f7;
    --card:#fff;
    --head:#f0f0f0;
    --btn:#0b5ed7;
    --btn2:#198754;
    --btn3:#6c757d;
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Arial,system-ui;padding:10px}
  .wrap{max-width:1500px;margin:auto}

  .toolbar{
    display:flex;flex-wrap:wrap;gap:8px;
    background:var(--card);border:1px solid var(--border);
    padding:10px;border-radius:8px;margin-bottom:10px;
    align-items:flex-end;
  }
  .field{display:flex;flex-direction:column;gap:4px}
  .field label{font-size:12px;font-weight:700}
  .field input,.field select{
    height:34px;padding:6px 8px;border:1px solid #c7c7c7;border-radius:6px;
    font-size:13px;min-width:170px;background:#fff;
  }
  .field.small input{min-width:120px}
  .field.tiny input{min-width:90px}

  .btn{
    height:34px;border:none;border-radius:6px;
    padding:0 12px;color:#fff;font-weight:800;cursor:pointer;font-size:13px;
  }
  .btn.primary{background:var(--btn)}
  .btn.success{background:var(--btn2)}
  .btn.gray{background:var(--btn3)}
  .btn:active{transform:translateY(1px)}
  .hint{font-size:12px;color:#333;margin-left:auto;max-width:520px}

  /* Sheet */
  #taDaSheet{
    background:var(--card);border:1px solid var(--border);
    padding:10px;border-radius:8px;
  }

  table{width:100%;border-collapse:collapse}
  .header-grid td{
    border:1px solid var(--border);
    padding:6px;
    font-size:12px;
  }
  .header-title{
    text-align:center;font-weight:900;font-size:14px;background:var(--head);
  }

  .main th,.main td{
    border:1px solid var(--border);
    text-align:center;
    padding:3px 4px;
    font-size:11px;
    line-height:1.1;
    vertical-align:middle;
  }
  .main th{background:var(--head);font-weight:900}

  /* Compact inputs inside table */
  .main input,.main select{
    width:100%;
    border:none;
    background:transparent;
    text-align:center;
    font-size:11px;
    padding:0;
    height:18px; /* row height control */
    outline:none;
  }
  .main td{height:22px}

  .left{text-align:left}
  .right{text-align:right}

  .footer{
    display:flex;justify-content:space-between;gap:10px;
    margin-top:8px;font-size:11px;
  }
  .line{
    border-bottom:1px solid #000;display:inline-block;min-width:180px;height:12px;vertical-align:bottom;
  }

  /* Make PDF output tighter without print dialog */
  .pdf-compact .main td{height:20px}
  .pdf-compact .main input,.pdf-compact .main select{height:16px;font-size:10px}
  .pdf-compact .main th{font-size:10px}
  .pdf-compact .main td{font-size:10px}
</style>
</head>

<body>
<div class="wrap">

  <!-- ===== TOOLBAR (all logic controls) ===== -->
  <div class="toolbar">
    <div class="field">
      <label>नाम / Name</label>
      <input id="name" placeholder="Name" />
    </div>
    <div class="field">
      <label>पदनाम / Designation</label>
      <input id="designation" placeholder="Designation" />
    </div>
    <div class="field small">
      <label>स्थान / Place</label>
      <input id="place" placeholder="Place" />
    </div>

    <div class="field tiny">
      <label>DA (₹)</label>
      <input id="rateDA" type="number" value="500" />
    </div>
    <div class="field tiny">
      <label>Hotel (₹)</label>
      <input id="rateHotel" type="number" value="750" />
    </div>

    <div class="field small">
      <label>From</label>
      <input id="fromDate" type="date" />
    </div>
    <div class="field small">
      <label>To</label>
      <input id="toDate" type="date" />
    </div>

    <button class="btn success" onclick="generateRows()">Generate Rows</button>
    <button class="btn gray" onclick="addRow()">+ Add Row</button>
    <button class="btn gray" onclick="clearAll()">Clear</button>

    <button class="btn primary" onclick="exportPDF()">⬇️ PDF</button>
    <button class="btn primary" onclick="exportExcel()">⬇️ Excel</button>

    <div class="hint">
      ✅ Rows auto-generate by date range • ✅ Auto totals • ✅ Editable fields • ✅ Save/Restore automatically
    </div>
  </div>

  <!-- ===== SHEET (export area) ===== -->
  <div id="taDaSheet">
    <table class="header-grid">
      <tr>
        <td colspan="8" class="header-title">दौरा भत्ता / दैनिक भत्ता गणना शीट  @ TA/DA CALCULATION SHEET</td>
      </tr>
      <tr>
        <td class="right"><b>नाम/Name</b></td>
        <td colspan="3"><span id="hName">-</span></td>
        <td class="right"><b>पदनाम/Designation</b></td>
        <td colspan="3"><span id="hDesig">-</span></td>
      </tr>
      <tr>
        <td class="right"><b>स्थान/Place</b></td>
        <td colspan="3"><span id="hPlace">-</span></td>
        <td class="right"><b>माह/Month</b></td>
        <td><span id="hMonth">-</span></td>
        <td class="right"><b>वर्ष/Year</b></td>
        <td><span id="hYear">-</span></td>
      </tr>
    </table>

    <table class="main" id="tadaTable">
      <thead>
        <tr>
          <th style="width:110px">Date</th>
          <th style="width:85px">No. of DA</th>
          <th style="width:80px">DA</th>
          <th style="width:90px">Hotel Bill</th>
          <th style="width:95px">Total DA</th>
          <th style="width:90px">Mode</th>
          <th style="width:85px">K.M.</th>
          <th style="width:95px">Total Fare</th>
          <th style="width:95px">Grand Total</th>
        </tr>
      </thead>

      <tbody id="rows"></tbody>

      <tfoot>
        <tr>
          <th colspan="1">Grand Total</th>
          <th id="gt_daCount">0</th>
          <th id="gt_da">0</th>
          <th id="gt_hotel">0</th>
          <th id="gt_totalDA">0</th>
          <th colspan="2"></th>
          <th id="gt_fare">0</th>
          <th id="gt_grand">0</th>
        </tr>
      </tfoot>
    </table>

    <div class="footer" id="footerLine">
      <div>दिनांक: <span class="line"></span></div>
      <div>सम्बन्धित क्षेत्र कर्मचारी के हस्ताक्षर: <span class="line"></span></div>
    </div>
  </div>
</div>

<script>
/* =========================
   ORIGINAL-STYLE LOGICS
   - Auto rows by date range
   - Auto calculation per row
   - Auto grand totals
   - Persistent save (localStorage)
   - PDF + Excel buttons (no print)
   ========================= */

const LS_KEY = "tada_sheet_v1";

function fmtINR(n){
  n = Number(n||0);
  return Math.round(n).toString();
}

function parseNum(v){
  const x = Number(String(v||"").replace(/[^0-9.\-]/g,""));
  return isNaN(x) ? 0 : x;
}

function setHeaderFromInputs(){
  const name = document.getElementById("name").value.trim() || "-";
  const desig = document.getElementById("designation").value.trim() || "-";
  const place = document.getElementById("place").value.trim() || "-";

  document.getElementById("hName").textContent = name;
  document.getElementById("hDesig").textContent = desig;
  document.getElementById("hPlace").textContent = place;

  // month/year from fromDate (if set), else today
  const from = document.getElementById("fromDate").value;
  const d = from ? new Date(from) : new Date();
  const m = d.toLocaleString("en-US",{month:"long"});
  const y = d.getFullYear();
  document.getElementById("hMonth").textContent = m;
  document.getElementById("hYear").textContent = y;
}

function makeRow(data={}){
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td><input type="date" class="r_date" value="${data.date||""}"></td>
    <td><input type="number" min="0" step="1" class="r_noDA" value="${data.noDA ?? 0}"></td>
    <td><input type="number" min="0" step="1" class="r_DA" value="${data.DA ?? 0}"></td>
    <td><input type="number" min="0" step="1" class="r_hotel" value="${data.hotel ?? 0}"></td>
    <td><input type="number" min="0" step="1" class="r_totalDA" value="${data.totalDA ?? 0}" readonly></td>
    <td>
      <select class="r_mode">
        ${renderModeOptions(data.mode)}
      </select>
    </td>
    <td><input type="number" min="0" step="1" class="r_km" value="${data.km ?? 0}"></td>
    <td><input type="number" min="0" step="1" class="r_fare" value="${data.fare ?? 0}"></td>
    <td><input type="number" min="0" step="1" class="r_grand" value="${data.grand ?? 0}" readonly></td>
  `;

  // attach events
  tr.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input", ()=>{ recalcRow(tr); recalcTotals(); saveAll(); });
    el.addEventListener("change", ()=>{ recalcRow(tr); recalcTotals(); saveAll(); setHeaderFromInputs(); });
  });

  // initial calc (in case)
  recalcRow(tr);
  return tr;
}

function renderModeOptions(selected){
  const modes = ["", "Bus", "Taxi", "Train", "Own Vehicle", "Other"];
  return modes.map(m=>{
    const sel = (m === (selected||"")) ? "selected" : "";
    const label = m==="" ? "" : m;
    return `<option value="${m}" ${sel}>${label}</option>`;
  }).join("");
}

function recalcRow(tr){
  const rateDA = parseNum(document.getElementById("rateDA").value);
  const rateHotel = parseNum(document.getElementById("rateHotel").value);

  const noDA = parseNum(tr.querySelector(".r_noDA").value);
  // DA field: auto = noDA*rateDA unless user typed custom (we keep it synced)
  // If user clears DA, we auto-fill
  let DA = parseNum(tr.querySelector(".r_DA").value);

  // Keep DA synced to rate * count (this matches your repeated requirement)
  const computedDA = noDA * rateDA;
  if (DA !== computedDA) {
    // If user manually changed DA, still allow? We'll force sync for consistency.
    DA = computedDA;
    tr.querySelector(".r_DA").value = computedDA ? computedDA : 0;
  }

  // Hotel: if blank and noDA>0, suggest rateHotel per day? Usually hotel is per night, not per DA.
  // We'll keep user-entered value, but if empty string, use 0.
  let hotel = parseNum(tr.querySelector(".r_hotel").value);
  // If user wants fixed hotel automatically per day, uncomment next line:
  // hotel = noDA>0 ? rateHotel : 0; tr.querySelector(".r_hotel").value = hotel;

  const totalDA = DA + hotel;
  tr.querySelector(".r_totalDA").value = totalDA;

  const fare = parseNum(tr.querySelector(".r_fare").value);
  const grand = totalDA + fare;
  tr.querySelector(".r_grand").value = grand;
}

function recalcTotals(){
  const trs = [...document.querySelectorAll("#rows tr")];
  let daCount=0, da=0, hotel=0, totalDA=0, fare=0, grand=0;

  trs.forEach(tr=>{
    daCount += parseNum(tr.querySelector(".r_noDA").value);
    da += parseNum(tr.querySelector(".r_DA").value);
    hotel += parseNum(tr.querySelector(".r_hotel").value);
    totalDA += parseNum(tr.querySelector(".r_totalDA").value);
    fare += parseNum(tr.querySelector(".r_fare").value);
    grand += parseNum(tr.querySelector(".r_grand").value);
  });

  document.getElementById("gt_daCount").textContent = fmtINR(daCount);
  document.getElementById("gt_da").textContent = fmtINR(da);
  document.getElementById("gt_hotel").textContent = fmtINR(hotel);
  document.getElementById("gt_totalDA").textContent = fmtINR(totalDA);
  document.getElementById("gt_fare").textContent = fmtINR(fare);
  document.getElementById("gt_grand").textContent = fmtINR(grand);
}

function addRow(prefill={}){
  const tbody = document.getElementById("rows");
  tbody.appendChild(makeRow(prefill));
  recalcTotals();
  saveAll();
}

function dateRange(from, to){
  const out=[];
  const d1 = new Date(from);
  const d2 = new Date(to);
  if (isNaN(d1) || isNaN(d2)) return out;
  d1.setHours(0,0,0,0); d2.setHours(0,0,0,0);
  if (d2 < d1) return out;
  for(let d=new Date(d1); d<=d2; d.setDate(d.getDate()+1)){
    out.push(new Date(d));
  }
  return out;
}

function generateRows(){
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  const list = dateRange(from, to);
  if (!list.length){
    // No alert spam; just create one empty row if none
    if (!document.querySelector("#rows tr")) addRow();
    setHeaderFromInputs();
    return;
  }

  document.getElementById("rows").innerHTML = "";
  list.forEach(d=>{
    const iso = d.toISOString().slice(0,10);
    // default: 1 DA for each date; you can change default to 0 if needed
    addRow({date: iso, noDA: 1});
  });

  setHeaderFromInputs();
  recalcTotals();
  saveAll();
}

function clearAll(){
  document.getElementById("rows").innerHTML = "";
  recalcTotals();
  saveAll();
}

function saveAll(){
  const payload = {
    meta:{
      name: document.getElementById("name").value || "",
      designation: document.getElementById("designation").value || "",
      place: document.getElementById("place").value || "",
      rateDA: document.getElementById("rateDA").value || "500",
      rateHotel: document.getElementById("rateHotel").value || "750",
      fromDate: document.getElementById("fromDate").value || "",
      toDate: document.getElementById("toDate").value || ""
    },
    rows: [...document.querySelectorAll("#rows tr")].map(tr=>({
      date: tr.querySelector(".r_date").value || "",
      noDA: parseNum(tr.querySelector(".r_noDA").value),
      DA: parseNum(tr.querySelector(".r_DA").value),
      hotel: parseNum(tr.querySelector(".r_hotel").value),
      totalDA: parseNum(tr.querySelector(".r_totalDA").value),
      mode: tr.querySelector(".r_mode").value || "",
      km: parseNum(tr.querySelector(".r_km").value),
      fare: parseNum(tr.querySelector(".r_fare").value),
      grand: parseNum(tr.querySelector(".r_grand").value),
    }))
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
}

function loadAll(){
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return false;
  try{
    const data = JSON.parse(raw);
    const m = data.meta || {};
    document.getElementById("name").value = m.name || "";
    document.getElementById("designation").value = m.designation || "";
    document.getElementById("place").value = m.place || "";
    document.getElementById("rateDA").value = m.rateDA || "500";
    document.getElementById("rateHotel").value = m.rateHotel || "750";
    document.getElementById("fromDate").value = m.fromDate || "";
    document.getElementById("toDate").value = m.toDate || "";

    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";
    (data.rows || []).forEach(r=> tbody.appendChild(makeRow(r)));
    setHeaderFromInputs();
    recalcTotals();
    return true;
  }catch(e){
    return false;
  }
}

function bindMeta(){
  ["name","designation","place","rateDA","rateHotel","fromDate","toDate"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      setHeaderFromInputs();
      // Recalc all rows if rate changes
      if (id==="rateDA" || id==="rateHotel"){
        document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
        recalcTotals();
      }
      saveAll();
    });
    document.getElementById(id).addEventListener("change", ()=>{
      setHeaderFromInputs();
      if (id==="rateDA" || id==="rateHotel"){
        document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
        recalcTotals();
      }
      saveAll();
    });
  });
}

/* ===== PDF EXPORT (no print dialog) ===== */
function exportPDF(){
  const sheet = document.getElementById("taDaSheet");
  sheet.classList.add("pdf-compact");

  const opt = {
    margin: 5,
    filename: makeFileName("TA_DA_Sheet", "pdf"),
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "landscape" },
    pagebreak: { mode: ["avoid-all"] }
  };

  html2pdf().set(opt).from(sheet).save().finally(()=>{
    sheet.classList.remove("pdf-compact");
  });
}

function makeFileName(prefix, ext){
  const nm = (document.getElementById("name").value || "User").trim().replace(/\s+/g,"_");
  const fd = document.getElementById("fromDate").value;
  const td = document.getElementById("toDate").value;
  const range = (fd && td) ? `${fd}_to_${td}` : "";
  return `${prefix}_${nm}${range?("_"+range):""}.${ext}`;
}

/* ===== EXCEL EXPORT =====
   Exports header + table data in a clean sheet.
*/
function exportExcel(){
  const wb = XLSX.utils.book_new();

  // Build AoA (array of arrays) to include header rows + table
  const aoa = [];

  const name = document.getElementById("hName").textContent;
  const desig = document.getElementById("hDesig").textContent;
  const place = document.getElementById("hPlace").textContent;
  const month = document.getElementById("hMonth").textContent;
  const year = document.getElementById("hYear").textContent;

  aoa.push(["TA/DA CALCULATION SHEET"]);
  aoa.push([]);
  aoa.push(["Name", name, "", "", "Designation", desig]);
  aoa.push(["Place", place, "", "", "Month", month, "Year", year]);
  aoa.push([]);

  // Table header
  aoa.push(["Date","No. of DA","DA","Hotel Bill","Total DA","Mode","K.M.","Total Fare","Grand Total"]);

  // Rows
  document.querySelectorAll("#rows tr").forEach(tr=>{
    aoa.push([
      tr.querySelector(".r_date").value || "",
      parseNum(tr.querySelector(".r_noDA").value),
      parseNum(tr.querySelector(".r_DA").value),
      parseNum(tr.querySelector(".r_hotel").value),
      parseNum(tr.querySelector(".r_totalDA").value),
      tr.querySelector(".r_mode").value || "",
      parseNum(tr.querySelector(".r_km").value),
      parseNum(tr.querySelector(".r_fare").value),
      parseNum(tr.querySelector(".r_grand").value),
    ]);
  });

  // Grand total row
  aoa.push([]);
  aoa.push([
    "Grand Total",
    parseNum(document.getElementById("gt_daCount").textContent),
    parseNum(document.getElementById("gt_da").textContent),
    parseNum(document.getElementById("gt_hotel").textContent),
    parseNum(document.getElementById("gt_totalDA").textContent),
    "",
    "",
    parseNum(document.getElementById("gt_fare").textContent),
    parseNum(document.getElementById("gt_grand").textContent),
  ]);

  const ws = XLSX.utils.aoa_to_sheet(aoa);

  // Simple column widths
  ws["!cols"] = [
    {wch:12},{wch:10},{wch:10},{wch:12},{wch:12},{wch:12},{wch:8},{wch:12},{wch:12}
  ];

  XLSX.utils.book_append_sheet(wb, ws, "TA_DA");
  XLSX.writeFile(wb, makeFileName("TA_DA_Sheet","xlsx"));
}

/* ===== INIT ===== */
(function init(){
  bindMeta();
  const ok = loadAll();
  setHeaderFromInputs();
  if (!ok){
    // start with 1 empty row so user sees table ready
    addRow();
  }
  recalcTotals();
})();
</script>
</body>
</html>