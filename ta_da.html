<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TA/DA Calculation Sheet</title>

<!-- Excel Export (SheetJS) -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --border:#000;
    --bg:#f3f5f7;
    --card:#fff;
    --muted:#64748b;
    --accent:#2563eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:16px;
    background:var(--bg);
    font-family: Arial, Helvetica, sans-serif;
    color:#111;
  }
  .sheet{
    max-width: 1250px;
    margin:auto;
    background:var(--card);
    border:1px solid #cfd6df;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
    padding:14px;
  }

  .topbar{
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
    margin-bottom:10px;
  }
  .title{
    text-align:center;
    font-weight:800;
    line-height:1.25;
    font-size:16px;
    flex:1;
  }
  .controls{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
    min-width: 320px;
  }
  .btn{
    border:1px solid #cbd5e1;
    background:#fff;
    padding:7px 10px;
    font-size:12.5px;
    font-weight:700;
    border-radius:8px;
    cursor:pointer;
    user-select:none;
  }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  .btn.danger{ background:#ef4444; color:#fff; border-color:#ef4444; }
  .btn:active{ transform: translateY(1px); }

  .meta{
    display:grid;
    grid-template-columns: 1.2fr 1fr 1fr 0.9fr 0.9fr;
    gap:6px;
    margin:10px 0 10px;
  }
  .field{
    border:1px solid var(--border);
    padding:6px 8px;
    display:flex;
    gap:8px;
    align-items:center;
    min-height:34px;
  }
  .label{
    font-weight:700;
    font-size:12px;
    white-space:nowrap;
  }
  .input{
    border:none;
    outline:none;
    font-size:12.5px;
    width:100%;
  }
  .select{
    width:100%;
    border:none;
    outline:none;
    font-size:12.5px;
    background:transparent;
  }

  table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
    font-size:11px;
  }
  th, td{
    border:1px solid var(--border);
    padding:4px 5px;
    text-align:center;
    vertical-align:middle;
    line-height:1.25;
    word-wrap:break-word;
    white-space:normal;
  }
  th{
    font-weight:800;
    background:#f1f5f9;
  }

  td input, td select{
    width:100%;
    border:none;
    outline:none;
    font-size:11px;
    padding:2px 3px;
    background:transparent;
    text-align:center;
  }
  td input[type="number"]{ appearance:textfield; }
  td .ro{
    display:block;
    font-weight:800;
  }
  tfoot td{
    font-weight:900;
    background:#f8fafc;
  }

  .footer-line{
    margin-top:14px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    font-size:12px;
  }
  .muted{ color:var(--muted); font-weight:700; }

  /* ===== PRINT: readable, A4 landscape ===== */
  @media print{
    @page{ size: A4 landscape; margin: 10mm; }
    body{ background:#fff; padding:0; margin:0; }
    .sheet{ box-shadow:none; border:none; padding:0; max-width:100%; }
    .controls{ display:none !important; }
    table{ font-size:10.5px; }
    tr{ page-break-inside:avoid; }
    table{ page-break-inside:avoid; }
  }
</style>
</head>

<body>
<div class="sheet" id="sheet">

  <div class="topbar">
    <div class="title">
      दौरा भत्ता / दैनिक भत्ता गणना शीट<br/>
      <span class="muted">TA / DA CALCULATION SHEET</span>
    </div>

    <div class="controls no-print">
      <button class="btn" onclick="addRow()">+ Add Row</button>
      <button class="btn danger" onclick="removeSelectedRows()">Remove Selected</button>
      <button class="btn" onclick="recalcAll()">Recalculate</button>
      <button class="btn primary" onclick="generatePDF()">Generate PDF</button>
      <button class="btn primary" onclick="exportExcel()">Export Excel</button>
    </div>
  </div>

  <div class="meta">
    <div class="field">
      <div class="label">नाम / Name</div>
      <input id="name" class="input" placeholder="Enter name" />
    </div>

    <div class="field">
      <div class="label">पदनाम / Designation</div>
      <input id="designation" class="input" placeholder="Enter designation" />
    </div>

    <div class="field">
      <div class="label">स्थान / Place</div>
      <input id="place" class="input" placeholder="Enter place" />
    </div>

    <div class="field">
      <div class="label">Month</div>
      <select id="month" class="select" onchange="generateMonthRows()"></select>
    </div>

    <div class="field">
      <div class="label">Year</div>
      <input id="year" class="input" type="number" min="2000" max="2100" value="2026" onchange="generateMonthRows()" />
    </div>
  </div>

  <table id="tadaTable">
    <thead>
      <tr>
        <th style="width:3.8%">Sel</th>
        <th style="width:7%">Date</th>
        <th style="width:8%">No. of DA</th>
        <th style="width:8%">DA</th>
        <th style="width:10%">Hotel Bill</th>
        <th style="width:10%">Total DA</th>
        <th style="width:12%">Mode</th>
        <th style="width:8%">K.M.</th>
        <th style="width:10%">Rate/KM</th>
        <th style="width:10%">Total Fare</th>
        <th style="width:13%">Grand Total</th>
      </tr>
    </thead>

    <tbody id="tbody">
      <!-- rows auto generated -->
    </tbody>

    <tfoot>
      <tr>
        <td colspan="2">Grand Total</td>
        <td id="sumDAcount">0</td>
        <td id="sumDA">0</td>
        <td id="sumHotel">0</td>
        <td id="sumTotalDA">0</td>
        <td></td>
        <td></td>
        <td></td>
        <td id="sumFare">0</td>
        <td id="sumGrand">0</td>
      </tr>
    </tfoot>
  </table>

  <div class="footer-line">
    <div>दिनांक: ____________________</div>
    <div>संबन्धित क्षेत्र कर्मचारी के हस्ताक्षर</div>
  </div>
</div>

<script>
/* ===================== DEFAULTS ===================== */
const DEFAULT_DA = 500;
const DEFAULT_HOTEL = 750;
const DEFAULT_RATE_KM = 0; // keep 0 by default; user can enter (or you can set e.g. 10)

const MODES = ["", "Bus", "Taxi", "Train", "Own Vehicle", "Walk", "Other"];

function money(n){
  const x = Number(n || 0);
  return (Math.round(x * 100) / 100).toString();
}

function daysInMonth(year, monthIndex){
  // monthIndex: 0-11
  return new Date(year, monthIndex + 1, 0).getDate();
}

/* ===================== BUILD MONTH DROPDOWN ===================== */
(function initMonth(){
  const m = document.getElementById("month");
  const months = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];
  months.forEach((name,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = name;
    m.appendChild(opt);
  });
  // set current month by default
  const now = new Date();
  m.value = now.getMonth();
  document.getElementById("year").value = now.getFullYear();
  generateMonthRows();
})();

/* ===================== ROW TEMPLATE ===================== */
function rowHTML(dateStr=""){
  const modeOptions = MODES.map(v => `<option value="${v}">${v || "—"}</option>`).join("");
  return `
    <tr>
      <td><input type="checkbox" class="rowSel" /></td>
      <td><input type="text" class="date" value="${dateStr}" placeholder="DD" /></td>

      <td><input type="number" class="daCount" min="0" value="1" oninput="recalcRow(this)" /></td>
      <td><input type="number" class="da" min="0" value="${DEFAULT_DA}" oninput="recalcRow(this)" /></td>
      <td><input type="number" class="hotel" min="0" value="${DEFAULT_HOTEL}" oninput="recalcRow(this)" /></td>

      <td><span class="ro totalDA">0</span></td>

      <td>
        <select class="mode" onchange="recalcRow(this)">${modeOptions}</select>
      </td>

      <td><input type="number" class="km" min="0" value="0" oninput="recalcRow(this)" /></td>
      <td><input type="number" class="rate" min="0" value="${DEFAULT_RATE_KM}" oninput="recalcRow(this)" /></td>

      <td><span class="ro fare">0</span></td>
      <td><span class="ro grand">0</span></td>
    </tr>
  `;
}

/* ===================== GENERATE MONTH ROWS ===================== */
function generateMonthRows(){
  const monthIndex = Number(document.getElementById("month").value);
  const year = Number(document.getElementById("year").value || new Date().getFullYear());

  const totalDays = daysInMonth(year, monthIndex);
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  // NOTE: If you truly want ONE PAGE ALWAYS, keep rows limited.
  // Here we generate full month but print will overflow if too many rows.
  for(let d=1; d<=totalDays; d++){
    tbody.insertAdjacentHTML("beforeend", rowHTML(String(d).padStart(2,"0")));
  }
  recalcAll();
}

/* ===================== ADD / REMOVE ROWS ===================== */
function addRow(){
  document.getElementById("tbody").insertAdjacentHTML("beforeend", rowHTML(""));
  recalcAll();
}

function removeSelectedRows(){
  const tbody = document.getElementById("tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  rows.forEach(r=>{
    const chk = r.querySelector(".rowSel");
    if(chk && chk.checked) r.remove();
  });
  recalcAll();
}

/* ===================== CALCULATIONS ===================== */
/*
  Logic:
  TotalDA = (NoOfDA * DA) + Hotel
  Fare = KM * Rate/KM   (or user keeps 0 and enters km only; still OK)
  Grand = TotalDA + Fare
*/
function recalcRow(el){
  const tr = el.closest("tr");
  if(!tr) return;

  const daCount = Number(tr.querySelector(".daCount")?.value || 0);
  const da = Number(tr.querySelector(".da")?.value || 0);
  const hotel = Number(tr.querySelector(".hotel")?.value || 0);

  const km = Number(tr.querySelector(".km")?.value || 0);
  const rate = Number(tr.querySelector(".rate")?.value || 0);

  const totalDA = (daCount * da) + hotel;
  const fare = km * rate;
  const grand = totalDA + fare;

  tr.querySelector(".totalDA").textContent = money(totalDA);
  tr.querySelector(".fare").textContent = money(fare);
  tr.querySelector(".grand").textContent = money(grand);

  recalcTotals();
}

function recalcAll(){
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    recalcRow(tr); // works because recalcRow uses closest tr; passing tr is fine if handled
  });
  // If passing tr, closest("tr") will return itself? Not for element that isn't inside itself.
  // So we call recalcRow with a child element instead:
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    recalcRow(tr.querySelector("input,select") || tr);
  });
}

function recalcTotals(){
  let sumDAcount = 0;
  let sumDA = 0;
  let sumHotel = 0;
  let sumTotalDA = 0;
  let sumFare = 0;
  let sumGrand = 0;

  document.querySelectorAll("#tbody tr").forEach(tr=>{
    sumDAcount += Number(tr.querySelector(".daCount")?.value || 0);
    sumDA += Number(tr.querySelector(".da")?.value || 0) * Number(tr.querySelector(".daCount")?.value || 0);
    sumHotel += Number(tr.querySelector(".hotel")?.value || 0);
    sumTotalDA += Number(tr.querySelector(".totalDA")?.textContent || 0);
    sumFare += Number(tr.querySelector(".fare")?.textContent || 0);
    sumGrand += Number(tr.querySelector(".grand")?.textContent || 0);
  });

  document.getElementById("sumDAcount").textContent = money(sumDAcount);
  document.getElementById("sumDA").textContent = money(sumDA);
  document.getElementById("sumHotel").textContent = money(sumHotel);
  document.getElementById("sumTotalDA").textContent = money(sumTotalDA);
  document.getElementById("sumFare").textContent = money(sumFare);
  document.getElementById("sumGrand").textContent = money(sumGrand);
}

/* ===================== PDF (PRINT) ===================== */
function generatePDF(){
  // Uses browser print dialog (Save as PDF). Print CSS ensures readability.
  window.print();
}

/* ===================== EXCEL EXPORT ===================== */
function exportExcel(){
  const wb = XLSX.utils.book_new();

  // Header info
  const meta = [
    ["TA/DA CALCULATION SHEET"],
    ["Name", document.getElementById("name").value || ""],
    ["Designation", document.getElementById("designation").value || ""],
    ["Place", document.getElementById("place").value || ""],
    ["Month", document.getElementById("month").selectedOptions[0].textContent, "Year", document.getElementById("year").value || ""],
    []
  ];

  // Table rows
  const data = [];
  data.push(["Date","No. of DA","DA","Hotel Bill","Total DA","Mode","KM","Rate/KM","Total Fare","Grand Total"]);

  document.querySelectorAll("#tbody tr").forEach(tr=>{
    data.push([
      tr.querySelector(".date")?.value || "",
      Number(tr.querySelector(".daCount")?.value || 0),
      Number(tr.querySelector(".da")?.value || 0),
      Number(tr.querySelector(".hotel")?.value || 0),
      Number(tr.querySelector(".totalDA")?.textContent || 0),
      tr.querySelector(".mode")?.value || "",
      Number(tr.querySelector(".km")?.value || 0),
      Number(tr.querySelector(".rate")?.value || 0),
      Number(tr.querySelector(".fare")?.textContent || 0),
      Number(tr.querySelector(".grand")?.textContent || 0),
    ]);
  });

  data.push([]);
  data.push(["Grand Total","","","","","","","","", Number(document.getElementById("sumGrand").textContent || 0)]);

  const ws1 = XLSX.utils.aoa_to_sheet(meta.concat(data));
  XLSX.utils.book_append_sheet(wb, ws1, "TA_DA");

  const fileName = `TA_DA_${document.getElementById("month").selectedOptions[0].textContent}_${document.getElementById("year").value}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

/* ===================== SMALL FIX: recalcRow when passed TR ===================== */
const _recalcRow = recalcRow;
recalcRow = function(el){
  // allow passing TR directly
  if(el && el.tagName === "TR"){
    const first = el.querySelector("input,select,span") || el;
    return _recalcRow(first);
  }
  return _recalcRow(el);
};
</script>

</body>
</html>