<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TA/DA Calculation Sheet</title>

<style>
  body{
    margin:0;
    padding:18px;
    background:#f3f5f7;
    font-family: Arial, Helvetica, sans-serif;
    color:#111;
  }
  .sheet{
    max-width:1200px;
    margin:auto;
    background:#fff;
    padding:14px;
    border:1px solid #cfd6df;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
  }

  table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
    font-size:13px;
  }
  td, th{
    border:1px solid #000;
    padding:6px 6px;
    text-align:center;
    vertical-align:middle;
    word-wrap:break-word;
  }

  .title{
    font-weight:700;
    font-size:16px;
    padding:10px 6px;
  }
  .hdrline{
    text-align:left;
    font-weight:600;
  }

  input, select{
    width:100%;
    border:none;
    outline:none;
    background:transparent;
    text-align:center;
    font-size:13px;
    padding:2px 0;
    font-family: inherit;
  }
  .left input, .left select{ text-align:left; padding-left:2px; }
  .left{ text-align:left; }

  .grouphead{ font-weight:700; }
  .colhead th{ font-weight:700; }
  .totalrow td{ font-weight:700; }

  .rate-badge{
    font-weight:700;
    text-align:right;
    font-size:12px;
  }
  .rate-badge span{
    display:inline-block;
    padding:2px 8px;
    border:1px solid #000;
    border-radius:999px;
    margin-left:6px;
  }

  .mini{
    display:inline-flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .mini input[type="date"]{
    width:160px;
    border:1px solid #000;
    padding:4px 6px;
    border-radius:6px;
    background:#fff;
    text-align:left;
  }

  .btn-mini{
    border:none;
    cursor:pointer;
    font-weight:800;
    padding:6px 10px;
    border-radius:8px;
    background:#1a4f8d;
    color:#fff;
  }
  .btn-mini.gray{ background:#2f3b4a; }
  .btn-mini.red{ background:#b42318; }
  .btn-mini:active{ transform: scale(.99); }

  .ranges{
    margin-top:8px;
    border:1px solid #000;
    border-radius:10px;
    padding:10px;
    background:#fff;
  }
  .ranges h4{
    margin:0 0 8px;
    font-size:12.5px;
    font-weight:900;
    letter-spacing:.2px;
  }
  .range-list{
    display:grid;
    grid-template-columns: 1fr;
    gap:6px;
  }
  .range-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:8px 10px;
    border:1px solid #000;
    border-radius:10px;
    background:#f8fafc;
    font-weight:800;
    font-size:12px;
  }
  .range-item .meta{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .range-item code{
    background:#fff;
    border:1px solid #000;
    padding:2px 6px;
    border-radius:999px;
    font-family: Arial, Helvetica, sans-serif;
    font-weight:900;
  }
  .range-item .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  .actionsbar{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
    margin-top:12px;
  }
  .btn{
    cursor:pointer;
    border:none;
    border-radius:6px;
    padding:10px 14px;
    font-weight:900;
    background:#1a4f8d;
    color:#fff;
  }
  .btn.secondary{ background:#2f3b4a; }
  .btn.danger{ background:#b42318; }

  tr.sel{
    outline: 3px solid #1a4f8d;
    outline-offset:-3px;
    background:#eef6ff;
  }

  .hotelMark{
    font-size:11px;
    font-weight:900;
  }

  /* ================= PRINT FIXES (ADDED) ================= */
  @media print {

  /* 1Ô∏è‚É£ Force A4 Landscape ALWAYS */
  @page {
    size: A4 landscape;
    margin: 5mm;
  }

  /* 2Ô∏è‚É£ Kill browser margins & backgrounds */
  html, body {
    margin: 0 !important;
    padding: 0 !important;
    background: #fff !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* 3Ô∏è‚É£ Fit EVERYTHING into ONE page */
  body {
    transform: scale(0.82);          /* üîë key for single page */
    transform-origin: top left;
    width: 120%;
  }

  .sheet {
    max-width: none !important;
    width: 100% !important;
    box-shadow: none !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  /* 4Ô∏è‚É£ Hide non-print sections */
  .actionsbar,
  .ranges,
  tr.print-hide {
    display: none !important;
  }

  /* 5Ô∏è‚É£ Tighten table for print */
  table {
    width: 100% !important;
    table-layout: fixed !important;
    font-size: 10px !important;
  }

  th, td {
    padding: 3px 3px !important;
  }

  /* 6Ô∏è‚É£ HARD STOP on page breaks */
  table, tr, td, th {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }
}
</style>
</head>

<body>
<div class="sheet">

  <table id="tada">
    <colgroup>
      <col style="width:12.5%">
      <col style="width:10.5%">
      <col style="width:10.5%">
      <col style="width:10.5%">
      <col style="width:11%">
      <col style="width:10%">
      <col style="width:10%">
      <col style="width:10.5%">
      <col style="width:14.5%">
    </colgroup>

    <tr><td colspan="9" style="border:none; padding:4px;"></td></tr>

    <tr>
      <td colspan="9" class="title">
        ‡§¶‡•ã‡§∞‡§æ ‡§≠‡§§‡•ç‡§§‡§æ / ‡§¶‡•à‡§®‡§ø‡§ï ‡§≠‡§§‡•ç‡§§‡§æ ‡§ó‡§£‡§®‡§æ ‡§™‡§§‡•ç‡§∞ &nbsp;|&nbsp; TA/DA CALCULATION SHEET
      </td>
    </tr>

    <tr><td colspan="9" style="border:none; padding:6px;"></td></tr>

    <tr>
      <td colspan="5" class="hdrline left">
        ‡§®‡§æ‡§Æ/Name :
        <input id="name" class="left" placeholder="Enter Name" />
      </td>
      <td colspan="4" class="hdrline left">
        ‡§™‡§¶-‡§®‡§æ‡§Æ/Designation :
        <select id="desig" class="left" onchange="updateRates()">
          <option value="">Select Designation</option>
          <option value="ENUM">Enumerator</option>
          <option value="SUP">Survey Supervisor</option>
          <option value="SSO">Senior Statistical Officer</option>
        </select>
      </td>
    </tr>

    <tr>
      <td colspan="3" class="hdrline left">
        ‡§∏‡•ç‡§•‡§æ‡§® /Place :
        <input id="place" class="left" placeholder="Enter Place" />
      </td>
      <td colspan="3" class="hdrline left">
        ‡§Æ‡§æ‡§π/Month :
        <input id="month" class="left" type="month" />
      </td>
      <td colspan="3" class="hdrline left">
        ‡§µ‡§∞‡•ç‡§∑ /Year :
        <input id="year" class="left" type="number" placeholder="2025" />
      </td>
    </tr>

    <!-- Multi Range Controller -->
    <tr class="print-hide">
      <td colspan="9" class="hdrline left">
        <div class="mini">
          <span><b>Tour Range:</b></span>
          <span>From</span>
          <input id="fromDate" type="date" />
          <span>To</span>
          <input id="toDate" type="date" />
          <span>Total Days: <b id="tourDays">0</b></span>
          <button type="button" class="btn-mini" onclick="addRange()">Add Range</button>
          <button type="button" class="btn-mini gray" onclick="generateAllRanges()">Generate All Ranges</button>
        </div>

        <div class="ranges" id="rangesBox">
          <h4>Saved Ranges (multiple allowed in month)</h4>
          <div class="range-list" id="rangeList"></div>
        </div>
      </td>
    </tr>

    <tr class="print-hide">
      <td colspan="9" class="rate-badge">
        Applied Rates:
        <span id="rateText">DA ‚Çπ0 | Hotel ‚Çπ0</span>
        <span style="margin-left:10px;">Tip:</span>
        <span style="border-style:dashed;">Click row to select ‚Ä¢ ‚ÄúAdd Journey Day‚Äù duplicates selected date ‚Ä¢ Double-tap Hotel cell toggles No-Hotel</span>
      </td>
    </tr>

    <tr>
      <td class="grouphead"></td>
      <td colspan="4" class="grouphead">DA Details</td>
      <td colspan="3" class="grouphead">Travelling Detail</td>
      <td class="grouphead"></td>
    </tr>

    <tr class="colhead">
      <th>Date</th>
      <th>No. of DA</th>
      <th>DA Amount</th>
      <th>Hotel Bill</th>
      <th>Total DA (3+4)</th>
      <th>Mode</th>
      <th>K.M.</th>
      <th>Total Fare</th>
      <th>Total (5+8)</th>
    </tr>

    <tbody id="rows"></tbody>

    <tr class="totalrow">
      <td colspan="2" class="left">Grand Total</td>
      <td id="gDA">0</td>
      <td id="gHotel">0</td>
      <td id="gTDA">0</td>
      <td></td>
      <td></td>
      <td id="gFare">0</td>
      <td id="gAll">0</td>
    </tr>

    <tr>
      <td colspan="9" class="left" style="border-top:none; padding-top:16px;">
        <span style="font-weight:700;">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï:-</span>
        <span style="display:inline-block; width:220px; border-bottom:1px solid #000; margin:0 14px 0 8px;"></span>
        <span style="float:right; font-weight:700;">‡§∏‡§Ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞</span>
      </td>
    </tr>
  </table>

  <div class="actionsbar">
    <button class="btn secondary" onclick="addRow()">+ Add Row</button>
    <button class="btn secondary" onclick="duplicateSelected()">‚ûï Add Journey Day (Duplicate Selected)</button>
    <button class="btn danger" onclick="deleteSelected()">üóë Delete Selected</button>
    <button class="btn danger" onclick="clearRows()">Clear Rows</button>
    <button class="btn" onclick="window.print()">Print</button>
  </div>

</div>

<script>
  // ===== Rates =====
  let DA_RATE = 0;
  let HOTEL_RATE = 0;

  const rowsEl = document.getElementById("rows");
  const rateText = document.getElementById("rateText");
  const rangeList = document.getElementById("rangeList");

  // Ranges array: {id, fromISO, toISO, days}
  let ranges = [];
  let selectedRow = null;

  function money(n){
    n = Number(n || 0);
    const rounded = Math.round(n * 100) / 100;
    return Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(2);
  }

  function updateRates(){
    const d = document.getElementById("desig").value;

    if(d === "ENUM"){
      DA_RATE = 400;
      HOTEL_RATE = 750;
    } else if(d === "SUP"){
      DA_RATE = 500;
      HOTEL_RATE = 750;
    } else if(d === "SSO"){
      DA_RATE = 1000;
      HOTEL_RATE = 968;
    } else {
      DA_RATE = 0;
      HOTEL_RATE = 0;
    }

    rateText.textContent = `DA ‚Çπ${money(DA_RATE)} | Hotel ‚Çπ${money(HOTEL_RATE)}`;
    recalc();
  }

  // ===== Tour Range helpers =====
  function parseDate(v){
    if(!v) return null;
    const d = new Date(v + "T00:00:00");
    return isNaN(d) ? null : d;
  }

  function toISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function dayDiffInclusive(a, b){
    const ms = 24*60*60*1000;
    const diff = Math.round((b - a) / ms);
    return diff >= 0 ? diff + 1 : 0;
  }

  function updateTourDaysUI(){
    const from = parseDate(document.getElementById("fromDate").value);
    const to   = parseDate(document.getElementById("toDate").value);
    const days = (from && to) ? dayDiffInclusive(from, to) : 0;
    document.getElementById("tourDays").textContent = days;
    return { from, to, days };
  }

  document.addEventListener("input", (e)=>{
    if(e.target && (e.target.id === "fromDate" || e.target.id === "toDate")){
      updateTourDaysUI();
    }
  });

  function addRange(){
    const { from, to, days } = updateTourDaysUI();
    if(!from || !to || !days) return;

    const item = {
      id: String(Date.now()) + "_" + Math.floor(Math.random()*9999),
      fromISO: toISO(from),
      toISO: toISO(to),
      days
    };
    ranges.push(item);
    renderRanges();
  }

  function removeRange(id){
    ranges = ranges.filter(r => r.id !== id);
    renderRanges();
  }

  function renderRanges(){
    rangeList.innerHTML = "";
    if(!ranges.length){
      rangeList.innerHTML = `<div style="font-weight:800; color:#333;">No ranges added yet.</div>`;
      return;
    }

    ranges.forEach((r, idx)=>{
      const div = document.createElement("div");
      div.className = "range-item";
      div.innerHTML = `
        <div class="meta">
          <span><b>Range ${idx+1}:</b></span>
          <code>${r.fromISO}</code>
          <span>to</span>
          <code>${r.toISO}</code>
          <span>(Days: <b>${r.days}</b>)</span>
        </div>
        <div class="actions">
          <button class="btn-mini" type="button" onclick="generateRange('${r.id}', true)">Append Rows</button>
          <button class="btn-mini gray" type="button" onclick="generateRange('${r.id}', false)">Replace Rows</button>
          <button class="btn-mini red" type="button" onclick="removeRange('${r.id}')">Remove</button>
        </div>
      `;
      rangeList.appendChild(div);
    });
  }

  // Generate rows for a specific range
  // append=true -> add to existing; append=false -> replace table rows with this range only
  function generateRange(id, append){
    const r = ranges.find(x => x.id === id);
    if(!r) return;

    const from = parseDate(r.fromISO);
    const to = parseDate(r.toISO);
    const days = dayDiffInclusive(from, to);
    if(!append) rowsEl.innerHTML = "";

    const cur = new Date(from);
    for(let i=0;i<days;i++){
      const iso = toISO(cur);
      const isLastDay = (i === days - 1);

      addRow({
        date: iso,
        days: 1,
        noHotel: isLastDay,
        rangeId: r.id
      });

      cur.setDate(cur.getDate() + 1);
    }

    sortRowsByDate();
    recalc();
  }

  function generateAllRanges(){
    if(!ranges.length) return;
    rowsEl.innerHTML = "";
    ranges.forEach(r => generateRange(r.id, true)); // append
    sortRowsByDate();
    recalc();
  }

  // ===== Rows / selection / journey day =====
  function addRow(prefill = {}){
    const tr = document.createElement("tr");

    // no hotel flag & range id tracking
    tr.dataset.nohotel = prefill.noHotel ? "1" : "0";
    tr.dataset.rangeid = prefill.rangeId || "";

    tr.innerHTML = `
      <td><input type="date" value="${prefill.date || ""}" oninput="recalc()"></td>
      <td><input type="number" min="0" step="1" value="${prefill.days ?? 1}" oninput="recalc()"></td>
      <td class="da">0</td>
      <td class="hotel">0</td>
      <td class="tda">0</td>
      <td><input value="${prefill.mode || ""}"></td>
      <td><input type="number" min="0" step="0.1" value="${prefill.km || ""}" oninput="recalc()"></td>
      <td><input type="number" min="0" step="0.01" value="${prefill.fare || ""}" oninput="recalc()"></td>
      <td class="total">0</td>
    `;

    // click select row
    tr.addEventListener("click", ()=>{
      selectRow(tr);
    });

    // double-click hotel cell toggles no-hotel (useful after edits)
    tr.querySelector(".hotel").addEventListener("dblclick", (e)=>{
      e.stopPropagation();
      tr.dataset.nohotel = (tr.dataset.nohotel === "1") ? "0" : "1";
      recalc();
    });

    rowsEl.appendChild(tr);
    recalc();
  }

  function selectRow(tr){
    if(selectedRow) selectedRow.classList.remove("sel");
    selectedRow = tr;
    selectedRow.classList.add("sel");
  }

  function duplicateSelected(){
    if(!selectedRow) return;

    const date = selectedRow.children[0].querySelector("input").value;
    const days = selectedRow.children[1].querySelector("input").value;
    const mode = selectedRow.children[5].querySelector("input").value;
    const km   = selectedRow.children[6].querySelector("input").value;
    const fare = selectedRow.children[7].querySelector("input").value;

    // Journey day row: same date, default hotel same as original (but you can toggle)
    addRow({
      date,
      days: Number(days || 1),
      mode,
      km,
      fare,
      noHotel: false,
      rangeId: selectedRow.dataset.rangeid || ""
    });

    sortRowsByDate();
    recalc();
  }

  function deleteSelected(){
    if(!selectedRow) return;
    selectedRow.remove();
    selectedRow = null;
    recalc();
  }

  function clearRows(){
    rowsEl.innerHTML = "";
    selectedRow = null;
    // keep 3 blank rows like sheet feel
    addRow(); addRow(); addRow();
  }

  function sortRowsByDate(){
    const trs = Array.from(rowsEl.querySelectorAll("tr"));
    trs.sort((a,b)=>{
      const da = a.children[0].querySelector("input").value || "9999-12-31";
      const db = b.children[0].querySelector("input").value || "9999-12-31";
      if(da < db) return -1;
      if(da > db) return 1;
      return 0; // same date -> keep insertion order (journey days remain grouped)
    });
    rowsEl.innerHTML = "";
    trs.forEach(tr => rowsEl.appendChild(tr));
  }

  // ===== Calculation =====
  function recalc(){
    let gDA = 0, gHotel = 0, gTDA = 0, gFare = 0, gAll = 0;

    [...rowsEl.querySelectorAll("tr")].forEach(tr => {
      const days = Number(tr.children[1].querySelector("input").value || 0);
      const fare = Number(tr.children[7].querySelector("input").value || 0);

      const da = days * DA_RATE;

      const noHotel = tr.dataset.nohotel === "1";
      const hotel = noHotel ? 0 : (days * HOTEL_RATE);

      const tda = da + hotel;
      const total = tda + fare;

      tr.querySelector(".da").textContent = money(da);

      // hotel mark
      tr.querySelector(".hotel").textContent = money(hotel);
      tr.querySelector(".hotel").title = noHotel ? "No Hotel (toggled / last day)" : "Double-tap to toggle No-Hotel";

      tr.querySelector(".tda").textContent = money(tda);
      tr.querySelector(".total").textContent = money(total);

      gDA += da;
      gHotel += hotel;
      gTDA += tda;
      gFare += fare;
      gAll += total;
    });

    document.getElementById("gDA").textContent = money(gDA);
    document.getElementById("gHotel").textContent = money(gHotel);
    document.getElementById("gTDA").textContent = money(gTDA);
    document.getElementById("gFare").textContent = money(gFare);
    document.getElementById("gAll").textContent = money(gAll);
  }

  // Auto-fill year from month if empty
  document.getElementById("month").addEventListener("input", (e) => {
    const val = e.target.value; // yyyy-mm
    if(val && !document.getElementById("year").value){
      document.getElementById("year").value = val.split("-")[0];
    }
  });

  // Start: 3 empty rows + range list init
  addRow(); addRow(); addRow();
  updateRates();
  renderRanges();
</script>

</body>
</html>