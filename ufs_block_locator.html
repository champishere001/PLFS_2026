<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>UFS KML Viewer (Ward/Block Match + Sheet Directions + Live Console)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- toGeoJSON (KML -> GeoJSON) -->
  <script src="https://unpkg.com/@tmcw/togeojson@5.6.1/dist/togeojson.umd.js"></script>

  <!-- Turf (point-in-polygon) -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- JSZip (ZIP -> extract KMLs in browser) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1326;
      --border:#22304a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --radius:16px;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 420px at 15% 10%, rgba(56,189,248,.14), transparent 60%),
        radial-gradient(900px 420px at 85% 20%, rgba(167,139,250,.10), transparent 60%),
        radial-gradient(700px 400px at 35% 85%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
    }
    .wrap{
      width:min(1100px, 100%);
      margin: 14px auto 30px;
      padding: 0 12px;
    }
    .header{
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,19,38,.92));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
    }
    .title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
      line-height:1.25;
    }
    .badge{
      padding:6px 10px;
      border:1px solid var(--border);
      background: rgba(56,189,248,.10);
      color: var(--text);
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      white-space: nowrap;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,19,38,.92));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 12px 12px 10px;
      border-bottom:1px solid rgba(34,48,74,.7);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead .h{
      font-weight: 900;
      font-size: 14px;
      display:flex; align-items:center; gap:8px;
    }
    .cardBody{ padding: 12px; }

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
    }

    .btn{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(56,189,248,.22), rgba(56,189,248,.12));
      border-color: rgba(56,189,248,.30);
    }
    .btn.ok{
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.12));
      border-color: rgba(34,197,94,.30);
    }
    .btn.bad{
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.12));
      border-color: rgba(239,68,68,.30);
    }
    .btn.warn{
      background: linear-gradient(180deg, rgba(245,158,11,.22), rgba(245,158,11,.12));
      border-color: rgba(245,158,11,.35);
    }

    .inp, .sel{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline:none;
      font-weight: 700;
    }
    .inp:focus, .sel:focus{
      border-color: rgba(56,189,248,.45);
      box-shadow: 0 0 0 4px rgba(56,189,248,.14);
    }

    .two{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 920px){
      .two{ grid-template-columns: 1.1fr .9fr; }
    }

    #map{
      width:100%;
      height: 360px;
      border-radius: 16px;
      border:1px solid var(--border);
      overflow:hidden;
      background: #0b1220;
    }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi .box{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 10px 10px;
      min-height: 52px;
    }
    .kpi .lab{ color: var(--muted); font-size: 11px; font-weight: 800; }
    .kpi .val{ font-weight: 900; font-size: 13px; margin-top: 4px; word-break: break-word; }

    .dirBox{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 10px 10px;
      margin-top: 10px;
    }
    .dirBox .lab{ color: var(--muted); font-size: 11px; font-weight: 900; margin-bottom: 4px; }
    .dirBox .val{ font-weight: 800; font-size: 12px; line-height: 1.35; }

    #activityPanel{
      margin-top: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      overflow:hidden;
    }
    .activity-header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight: 900;
    }
    .activity-header button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 900;
      cursor:pointer;
    }
    #activityLog{
      max-height: 220px;
      overflow:auto;
      padding: 10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      line-height: 1.35;
    }
    .logline{ padding: 4px 0; border-bottom:1px dashed rgba(255,255,255,.06); }
    .logline.ok{ color: rgba(34,197,94,.95); }
    .logline.bad{ color: rgba(239,68,68,.95); }
    .logline.warn{ color: rgba(245,158,11,.95); }
    .logline.info{ color: rgba(229,231,235,.95); }

    .hint{
      color: var(--muted);
      font-size: 11px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .fileRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"]{ display:none; }
    .pill{
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-weight: 900;
      font-size: 12px;
    }

    .chk{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      color: var(--text);
      user-select:none;
    }
    .chk input{ transform: scale(1.1); }

    .selGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 720px){
      .selGrid{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>UFS KML Viewer (Ward/Block Match + Sheet Directions)</h1>
        <div class="badge" id="countBadge">0 boundaries</div>
      </div>
      <div class="sub">
        Upload KML/ZIP ‚Üí GPS location se boundary match ‚Üí KML filename se Ward/Block read ‚Üí Google Sheet se
        <b>IV No + Town + North/East/South/West</b> auto show.
      </div>
    </div>

    <div class="grid">

      <!-- Controls -->
      <div class="card">
        <div class="cardHead">
          <div class="h">‚öôÔ∏è Controls</div>
          <div class="fileRow">
            <label class="btn primary" for="kmlInput">Upload .kml / .zip</label>
            <input id="kmlInput" type="file" accept=".kml,.zip" multiple />
          </div>
        </div>

        <div class="cardBody">
          <div class="row">
            <input class="inp" id="proxyUrl" placeholder="Paste Apps Script Proxy URL here (required for Drive ZIP)" />
            <input class="inp" id="kmlUrl" value="https://drive.google.com/file/d/1I7SfE0fOOV-er-06U-q8dICbjmFMLZeK/view?usp=drivesdk" />

            <div class="controls">
              <button class="btn ok" id="fetchDriveBtn">Fetch ZIP from Drive</button>
              <button class="btn primary" id="loadKmlUrlBtn">Load URL (non-Drive)</button>
              <button class="btn" id="restoreSavedBtn">Restore Saved KML</button>
              <button class="btn warn" id="clearSavedBtn">Clear Saved KML</button>
              <label class="chk"><input type="checkbox" id="saveOfflineChk" checked>Save Offline</label>
              <label class="chk"><input type="checkbox" id="autoFetchChk">Auto-fetch Drive ZIP on open</label>
            </div>

            <input class="inp" id="sheetUrl" value="https://docs.google.com/spreadsheets/d/1MoKhZ2mzNtTgPvkM_xFk-TffpiYrkSRyNctOFQ5APBI/edit?usp=drivesdk" />

            <div class="controls">
              <button class="btn warn" id="loadSheetBtn">Load Sheet</button>
              <button class="btn ok" id="startGpsBtn">Start GPS</button>
              <button class="btn bad" id="stopGpsBtn">Stop</button>
              <button class="btn primary" id="detectNowBtn">Detect Now</button>
              <button class="btn" id="fitAllBtn">Fit All</button>
              <button class="btn" id="clearBtn">Clear</button>
            </div>

            <div class="hint">
              ‚úÖ Sheet must be public: Share ‚Üí General access ‚Üí <b>Anyone with the link</b> ‚Üí Viewer. <br/>
              KML filename example: <b>b14w6iv1.kml</b> (Block=14, Ward=6) <br/>
              ZIP must contain .kml files. (folders inside ZIP OK) <br/>
              ‚úÖ Drive ZIP fetch works via Proxy URL only (Apps Script Web App). <br/>
              ‚úÖ One-time upload: KML saves offline (IndexedDB) + auto-restore on open.
            </div>
          </div>
        </div>
      </div>

      <!-- Selection Console -->
      <div class="card">
        <div class="cardHead">
          <div class="h">üßæ Selection Console (Town / IV / Ward / Block)</div>
          <div class="pill" id="selStatus">Ready</div>
        </div>
        <div class="cardBody">
          <div class="selGrid">
            <select class="sel" id="townSel"><option value="">Town (All)</option></select>
            <select class="sel" id="ivSel"><option value="">IV No (All)</option></select>
            <select class="sel" id="wardSel"><option value="">Ward No (All)</option></select>
            <select class="sel" id="blockSel"><option value="">Block No (All)</option></select>
          </div>

          <div class="controls" style="margin-top:10px">
            <button class="btn primary" id="showSelectedBtn">Show Selected</button>
            <button class="btn" id="clearSelectionBtn">Clear Selection</button>
          </div>

          <div class="hint">
            ‚úÖ This console uses <b>Sheet data</b>. Boundary highlight uses <b>uploaded/offline KML</b> (Ward+Block match).
          </div>
        </div>
      </div>

      <div class="two">
        <!-- Map -->
        <div class="card">
          <div class="cardHead">
            <div class="h">üó∫Ô∏è Map</div>
            <div class="pill" id="gpsStatus">GPS: OFF</div>
          </div>
          <div class="cardBody">
            <div id="map"></div>

            <div id="activityPanel">
              <div class="activity-header">
                <span>üì° Live Activity Console</span>
                <button id="clearLogBtn">Clear</button>
              </div>
              <div id="activityLog"></div>
            </div>
          </div>
        </div>

        <!-- Detected Info -->
        <div class="card">
          <div class="cardHead">
            <div class="h">üìç Detected / Selected Info</div>
            <div class="pill" id="sheetStatus">Sheet: NOT LOADED</div>
          </div>
          <div class="cardBody">
            <div class="kpi">
              <div class="box">
                <div class="lab">Current Location</div>
                <div class="val" id="locVal">‚Äî</div>
              </div>
              <div class="box">
                <div class="lab">Inside Boundary</div>
                <div class="val" id="insideVal">‚Äî</div>
              </div>

              <div class="box">
                <div class="lab">Town (from Sheet col I)</div>
                <div class="val" id="townVal">‚Äî</div>
              </div>
              <div class="box">
                <div class="lab">IV No (from Sheet col B)</div>
                <div class="val" id="ivVal">‚Äî</div>
              </div>

              <div class="box">
                <div class="lab">Ward / Block (from KML name)</div>
                <div class="val" id="wbVal">‚Äî</div>
              </div>
              <div class="box">
                <div class="lab">Boundary BBox (N/S/E/W)</div>
                <div class="val" id="bboxVal">‚Äî</div>
              </div>
            </div>

            <div class="dirBox"><div class="lab">North</div><div class="val" id="northVal">No entry</div></div>
            <div class="dirBox"><div class="lab">East</div><div class="val" id="eastVal">No entry</div></div>
            <div class="dirBox"><div class="lab">South</div><div class="val" id="southVal">No entry</div></div>
            <div class="dirBox"><div class="lab">West</div><div class="val" id="westVal">No entry</div></div>

            <div class="hint" style="margin-top:10px">
              Matching key: <b>Ward No + Block Number</b>. Now also shows <b>Town + IV No</b> from the Sheet row.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* =========================
   Live Activity Console
========================= */
function logAct(msg, type="info"){
  const el = document.getElementById("activityLog");
  const t = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.className = "logline " + type;
  div.textContent = `‚Ä¢ ${t}  ${msg}`;
  el.prepend(div);
}
function clearActivity(){
  document.getElementById("activityLog").innerHTML = "";
  logAct("Console cleared", "warn");
}

/* =========================
   IndexedDB (Save KML offline)
========================= */
const DB_NAME = "ufs_kml_viewer_db";
const STORE = "kml_files";

function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath: "name" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPutKml(name, text){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).put({ name, text, savedAt: Date.now() });
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function idbGetAllKml(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

async function idbClearAll(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).clear();
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

/* =========================
   Helpers: CSV parse (handles quotes)
========================= */
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQuotes && next === '"'){ cur += '"'; i++; }
      else{ inQuotes = !inQuotes; }
    }else if(ch === ',' && !inQuotes){
      row.push(cur.trim()); cur = "";
    }else if((ch === '\n' || ch === '\r') && !inQuotes){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur.trim()); cur = "";
      if(row.length > 1 || (row.length===1 && row[0]!== "")){
        rows.push(row.map(x => x.replace(/^"|"$/g,"")));
      }
      row = [];
    }else{
      cur += ch;
    }
  }
  if(cur.length || row.length){
    row.push(cur.trim());
    if(row.length) rows.push(row.map(x => x.replace(/^"|"$/g,"")));
  }
  return rows.filter(r => r.some(c => String(c||"").trim()!==""));
}

const numOnly = v => String(v||"").replace(/\D/g,"");
const makeKey = (ward, block) => `w${numOnly(ward)}-b${numOnly(block)}`;
const norm = s => String(s||"").trim();

/* =========================
   Sheet load (CSV export)
========================= */
let sheetMap = new Map();     // key -> {north,east,south,west,town,iv}
let sheetRows = [];           // rows for dropdowns
let sheetLoaded = false;

function sheetIdFromUrl(u){
  const m = String(u||"").match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return m ? m[1] : null;
}

function findHeaderIndex(headers, wanted){
  // wanted can be array of candidate strings
  const low = headers.map(h => String(h||"").toLowerCase().trim());
  for(const cand of wanted){
    const idx = low.indexOf(cand.toLowerCase());
    if(idx !== -1) return idx;
  }
  return -1;
}

async function loadSheet(gid=0){
  const u = document.getElementById("sheetUrl").value.trim();
  const id = sheetIdFromUrl(u);
  if(!id){
    logAct("‚ùå Invalid Google Sheet URL", "bad");
    setSheetStatus(false, "Sheet: URL INVALID");
    return;
  }

  const csvUrl = `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;
  logAct("üì• Loading Sheet CSV: " + csvUrl);

  let text = "";
  try{
    const res = await fetch(csvUrl);
    text = await res.text();
  }catch(e){
    logAct("‚ùå Fetch failed: " + e.message, "bad");
    setSheetStatus(false, "Sheet: LOAD FAILED");
    return;
  }

  if(text.trim().startsWith("<!DOCTYPE html") || text.includes("ServiceLogin")){
    logAct("‚ùå Sheet not public / permission issue (got HTML login page)", "bad");
    setSheetStatus(false, "Sheet: NOT PUBLIC");
    return;
  }

  const rows = parseCSV(text);
  if(!rows.length){
    logAct("‚ùå CSV parsed but empty rows", "bad");
    setSheetStatus(false, "Sheet: EMPTY");
    return;
  }

  const headers = rows[0].map(h => String(h||"").trim());
  const headersLow = headers.map(h => h.toLowerCase().trim());

  // IMPORTANT: your sheet has "IV No" and "TOWN"
  const idx = {
    iv:    findHeaderIndex(headers, ["IV No","IV NO","IVNo","IV"]),
    ward:  findHeaderIndex(headers, ["Ward No","WARD NO","Ward"]),
    block: findHeaderIndex(headers, ["Block Number","BLOCK NUMBER","Block"]),
    north: findHeaderIndex(headers, ["North","NORTH"]),
    east:  findHeaderIndex(headers, ["East","EAST"]),
    south: findHeaderIndex(headers, ["South","SOUTH"]),
    west:  findHeaderIndex(headers, ["West","WEST"]),
    town:  findHeaderIndex(headers, ["Town","TOWN"]),
  };

  const required = ["iv","town","ward","block","north","east","south","west"];
  const missing = required.filter(k => idx[k] === -1);
  if(missing.length){
    logAct("‚ùå Headers missing: " + missing.join(", ") + " | Found: " + headers.join(" | "), "bad");
    setSheetStatus(false, "Sheet: WRONG HEADERS");
    return;
  }

  const map2 = new Map();
  const list = [];

  for(let i=1;i<rows.length;i++){
    const r = rows[i];

    const iv = norm(r[idx.iv]);
    const town = norm(r[idx.town]);

    const ward = numOnly(r[idx.ward]);
    const block = numOnly(r[idx.block]);
    if(!ward || !block) continue;

    const key = makeKey(ward, block);
    const item = {
      key,
      iv,
      town,
      ward,
      block,
      north: norm(r[idx.north]),
      east:  norm(r[idx.east]),
      south: norm(r[idx.south]),
      west:  norm(r[idx.west]),
    };

    map2.set(key, item);
    list.push(item);
  }

  sheetMap = map2;
  sheetRows = list;
  sheetLoaded = true;

  logAct("‚úÖ Sheet loaded. Keys: " + sheetMap.size, "ok");
  setSheetStatus(true, "Sheet: LOADED ("+sheetMap.size+")");

  buildSelectionOptions();
}

function setSheetStatus(ok, label){
  const el = document.getElementById("sheetStatus");
  el.textContent = label;
  el.style.borderColor = ok ? "rgba(34,197,94,.35)" : "rgba(239,68,68,.35)";
  el.style.background = ok ? "rgba(34,197,94,.10)" : "rgba(239,68,68,.08)";
}

function setSelStatus(txt){
  document.getElementById("selStatus").textContent = txt;
}

/* =========================
   Selection Console (Town/IV/Ward/Block)
========================= */
function uniqueSorted(arr){
  return Array.from(new Set(arr.filter(x => String(x||"").trim()!==""))).sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric:true}));
}
function fillSelect(sel, items, placeholder){
  const cur = sel.value;
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  sel.appendChild(opt0);
  for(const it of items){
    const o = document.createElement("option");
    o.value = it;
    o.textContent = it;
    sel.appendChild(o);
  }
  // keep selection if still available
  if(Array.from(sel.options).some(o => o.value === cur)){
    sel.value = cur;
  }else{
    sel.value = "";
  }
}

function filteredSheetRows(){
  const town = document.getElementById("townSel").value;
  const iv = document.getElementById("ivSel").value;
  const ward = document.getElementById("wardSel").value;
  const block = document.getElementById("blockSel").value;

  return sheetRows.filter(r => {
    if(town && r.town !== town) return false;
    if(iv && r.iv !== iv) return false;
    if(ward && String(r.ward) !== String(ward)) return false;
    if(block && String(r.block) !== String(block)) return false;
    return true;
  });
}

function buildSelectionOptions(){
  // initial full options based on current filters (cascading)
  const rows = filteredSheetRows();

  // For cascading, we rebuild each dropdown from partially filtered views
  // Step 1: Town from all rows
  fillSelect(document.getElementById("townSel"), uniqueSorted(sheetRows.map(r=>r.town)), "Town (All)");

  // Step 2: IV based on Town filter
  const town = document.getElementById("townSel").value;
  const rowsTown = sheetRows.filter(r => !town || r.town === town);
  fillSelect(document.getElementById("ivSel"), uniqueSorted(rowsTown.map(r=>r.iv)), "IV No (All)");

  // Step 3: Ward based on Town+IV
  const iv = document.getElementById("ivSel").value;
  const rowsTownIv = rowsTown.filter(r => !iv || r.iv === iv);
  fillSelect(document.getElementById("wardSel"), uniqueSorted(rowsTownIv.map(r=>String(r.ward))).map(String), "Ward No (All)");

  // Step 4: Block based on Town+IV+Ward
  const ward = document.getElementById("wardSel").value;
  const rowsTownIvWard = rowsTownIv.filter(r => !ward || String(r.ward) === String(ward));
  fillSelect(document.getElementById("blockSel"), uniqueSorted(rowsTownIvWard.map(r=>String(r.block))).map(String), "Block No (All)");

  setSelStatus(sheetLoaded ? `Filtered rows: ${filteredSheetRows().length}` : "Load Sheet first");
}

/* =========================
   Map init
========================= */
const map = L.map("map", { zoomControl:true }).setView([31.1048, 77.1734], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const boundaryLayer = L.featureGroup().addTo(map);
let gpsMarker = null;
let gpsAccuracy = null;
let watchId = null;
let lastPos = null;

/* =========================
   KML store
========================= */
const kmlItems = [];
function updateCount(){
  document.getElementById("countBadge").textContent = `${kmlItems.length} boundaries`;
}

function parseWardBlockFromName(filename){
  const s = (filename || "").toLowerCase();
  const b = (s.match(/b(\d+)/) || [])[1] || "";
  const w = (s.match(/w(\d+)/) || [])[1] || "";
  return { ward: w, block: b };
}

function geojsonToTurfPolygons(geojson){
  const polys = [];
  if(!geojson || !geojson.features) return polys;
  for(const f of geojson.features){
    if(!f || !f.geometry) continue;
    const g = f.geometry;
    if(g.type === "Polygon" || g.type === "MultiPolygon"){
      polys.push(f);
    }
  }
  return polys;
}

function computeBBoxFromGeoJSON(geojson){
  let N = -Infinity, S = Infinity, E = -Infinity, W = Infinity;

  function walkCoords(coords){
    if(typeof coords[0] === "number"){
      const lon = coords[0], lat = coords[1];
      if(lat > N) N = lat;
      if(lat < S) S = lat;
      if(lon > E) E = lon;
      if(lon < W) W = lon;
      return;
    }
    for(const c of coords) walkCoords(c);
  }

  if(geojson && geojson.features){
    for(const f of geojson.features){
      if(f.geometry && f.geometry.coordinates){
        walkCoords(f.geometry.coordinates);
      }
    }
  }
  if(!isFinite(N)) return null;
  return { N, S, E, W };
}

/* =========================
   UI setters
========================= */
function setText(id, v){ document.getElementById(id).textContent = v; }
function setDirText(n,e,s,w){
  setText("northVal", n || "No entry");
  setText("eastVal",  e || "No entry");
  setText("southVal", s || "No entry");
  setText("westVal",  w || "No entry");
}
function setTownIv(town, iv){
  setText("townVal", town || "‚Äî");
  setText("ivVal", iv || "‚Äî");
}

function setGpsStatus(on){
  const el = document.getElementById("gpsStatus");
  el.textContent = on ? "GPS: ON" : "GPS: OFF";
  el.style.borderColor = on ? "rgba(34,197,94,.35)" : "rgba(239,68,68,.35)";
  el.style.background = on ? "rgba(34,197,94,.10)" : "rgba(239,68,68,.08)";
}

/* =========================
   Highlight boundary by ward/block
========================= */
let highlightedLayer = null;
function highlightByWardBlock(ward, block){
  const w = String(ward||"");
  const b = String(block||"");
  const hit = kmlItems.find(it => String(it.ward||"")===w && String(it.block||"")===b);

  if(highlightedLayer){
    try{ highlightedLayer.setStyle({ weight: 2, opacity: 0.9, fillOpacity: 0.15 }); }catch(e){}
    highlightedLayer = null;
  }

  if(!hit){
    logAct(`‚ö†Ô∏è No KML found for w${w} b${b} (upload/restore KML)`, "warn");
    return null;
  }

  // set strong style
  try{ hit.layer.setStyle({ weight: 5, opacity: 1, fillOpacity: 0.25 }); }catch(e){}
  highlightedLayer = hit.layer;

  // zoom to it
  try{
    map.fitBounds(hit.layer.getBounds().pad(0.15));
  }catch(e){}

  logAct(`üéØ Highlighted boundary: ${hit.name} (w${w} b${b})`, "ok");
  return hit;
}

/* =========================
   Detect boundary for current point (GPS)
========================= */
function detectForLatLng(lat, lng){
  if(!kmlItems.length){
    logAct("‚ö†Ô∏è No boundaries loaded", "warn");
    return;
  }

  setText("locVal", `${lat.toFixed(6)}, ${lng.toFixed(6)}`);
  const pt = turf.point([lng, lat]);

  for(const item of kmlItems){
    if(!item.bbox) continue;
    if(lat > item.bbox.N || lat < item.bbox.S || lng > item.bbox.E || lng < item.bbox.W) continue;

    for(const f of item.polygons){
      try{
        if(turf.booleanPointInPolygon(pt, f)){
          setText("insideVal", item.name);
          setText("wbVal", `Ward w${item.ward || "?"} / Block b${item.block || "?"}`);

          const bb = item.bbox;
          setText("bboxVal", `N ${bb.N.toFixed(6)} | S ${bb.S.toFixed(6)} | E ${bb.E.toFixed(6)} | W ${bb.W.toFixed(6)}`);

          logAct(`‚úÖ Detected inside: ${item.name} (w${item.ward} b${item.block})`, "ok");

          if(sheetLoaded){
            const key = makeKey(item.ward, item.block);
            const hit = sheetMap.get(key);
            if(hit){
              setTownIv(hit.town, hit.iv);
              setDirText(hit.north || "‚Äî", hit.east || "‚Äî", hit.south || "‚Äî", hit.west || "‚Äî");
              logAct(`üßæ Sheet matched: ${key} (Town=${hit.town || "-"}, IV=${hit.iv || "-"})`, "ok");
            }else{
              setTownIv("‚Äî","‚Äî");
              setDirText("No entry","No entry","No entry","No entry");
              logAct(`‚ö†Ô∏è Sheet no match for key: ${key}`, "warn");
            }
          }else{
            setTownIv("‚Äî","‚Äî");
            setDirText("No entry","No entry","No entry","No entry");
            logAct("‚ö†Ô∏è Sheet not loaded yet (click Load Sheet)", "warn");
          }
          return;
        }
      }catch(e){
        logAct("‚ùå PIP error: " + e.message, "bad");
      }
    }
  }

  setText("insideVal", "Not inside any boundary");
  setText("wbVal", "‚Äî");
  setText("bboxVal", "‚Äî");
  setTownIv("‚Äî","‚Äî");
  setDirText("No entry","No entry","No entry","No entry");
  logAct("‚ÑπÔ∏è Not inside any boundary", "info");
}

/* =========================
   GPS start/stop
========================= */
function startGPS(){
  if(!navigator.geolocation){
    logAct("‚ùå Geolocation not supported", "bad");
    return;
  }
  if(watchId) return;

  watchId = navigator.geolocation.watchPosition(
    (pos) => {
      const { latitude, longitude, accuracy } = pos.coords;
      lastPos = { lat: latitude, lng: longitude, acc: accuracy };

      if(!gpsMarker){
        gpsMarker = L.circleMarker([latitude, longitude], { radius: 8 }).addTo(map);
      }else{
        gpsMarker.setLatLng([latitude, longitude]);
      }

      if(!gpsAccuracy){
        gpsAccuracy = L.circle([latitude, longitude], { radius: accuracy }).addTo(map);
      }else{
        gpsAccuracy.setLatLng([latitude, longitude]);
        gpsAccuracy.setRadius(accuracy);
      }

      setText("locVal", `${latitude.toFixed(6)}, ${longitude.toFixed(6)} (¬±${Math.round(accuracy)}m)`);
      logAct(`üìç GPS update: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} ¬±${Math.round(accuracy)}m`, "info");

      detectForLatLng(latitude, longitude);
    },
    (err) => {
      logAct("‚ùå GPS error: " + err.message, "bad");
      setGpsStatus(false);
      stopGPS();
    },
    { enableHighAccuracy:true, maximumAge: 5000, timeout: 20000 }
  );

  setGpsStatus(true);
  logAct("‚úÖ GPS started", "ok");
}

function stopGPS(){
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  setGpsStatus(false);
  logAct("üõë GPS stopped", "warn");
}

/* =========================
   Drive proxy fetch (REQUIRED for Drive ZIP)
========================= */
function extractDriveFileId(url){
  const u = String(url||"");
  let m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  m = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return m[1];
  return null;
}

function base64ToU8(b64){
  const bin = atob(b64);
  const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
  return u8;
}

function looksLikeZip(u8){
  return u8 && u8.length >= 2 && u8[0] === 0x50 && u8[1] === 0x4B;
}

async function fetchFromDriveViaProxy(fileId){
  const proxy = document.getElementById("proxyUrl").value.trim();
  if(!proxy){
    logAct("‚ùå Proxy URL missing. Paste Apps Script Web App URL in Proxy field.", "bad");
    return null;
  }
  const url = `${proxy}?id=${encodeURIComponent(fileId)}`;
  logAct("üîå Proxy fetch: " + url, "info");

  const res = await fetch(url);
  const data = await res.json();

  if(!data.ok){
    logAct("‚ùå Proxy error: " + (data.error || "unknown"), "bad");
    return null;
  }
  return data;
}

/* =========================
   Load KML from text
========================= */
async function addKmlFromText(name, text, saveOffline=true){
  const { ward, block } = parseWardBlockFromName(name);

  try{
    const xml = new DOMParser().parseFromString(text, "text/xml");
    const geojson = toGeoJSON.kml(xml);

    const layer = L.geoJSON(geojson, { style: { weight: 2, opacity: 0.9, fillOpacity: 0.15 } });
    layer.addTo(boundaryLayer);

    const bbox = computeBBoxFromGeoJSON(geojson);
    const polygons = geojsonToTurfPolygons(geojson);

    kmlItems.push({ name, ward, block, layer, geojson, bbox, polygons });
    updateCount();

    if(saveOffline){
      await idbPutKml(name, text);
      logAct(`üíæ Saved offline: ${name}`, "ok");
    }

    logAct(`‚úÖ Loaded KML: ${name} (w${ward||"?"} b${block||"?"})`, "ok");
  }catch(e){
    logAct(`‚ùå Failed to load ${name}: ${e.message}`, "bad");
  }
}

/* =========================
   Upload KML / ZIP (multi)
========================= */
async function handleKmlOrZipFiles(files){
  if(!files || !files.length) return;

  const saveOffline = document.getElementById("saveOfflineChk").checked;
  logAct(`üì¶ Selected ${files.length} file(s)`, "info");

  for(const file of files){
    const fname = (file.name || "").toLowerCase();

    if(fname.endsWith(".kml")){
      try{
        const text = await file.text();
        await addKmlFromText(file.name, text, saveOffline);
      }catch(e){
        logAct(`‚ùå Failed to read ${file.name}: ${e.message}`, "bad");
      }
      continue;
    }

    if(fname.endsWith(".zip")){
      try{
        logAct(`üóúÔ∏è Unzipping: ${file.name}`, "info");

        const zipData = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(zipData);

        const entries = Object.keys(zip.files);
        const kmlEntryNames = entries.filter(n => n.toLowerCase().endsWith(".kml") && !zip.files[n].dir);

        if(!kmlEntryNames.length){
          logAct(`‚ö†Ô∏è No .kml found inside ZIP: ${file.name}`, "warn");
          continue;
        }

        logAct(`üìÇ Found ${kmlEntryNames.length} KML in ZIP`, "ok");

        for(const entryName of kmlEntryNames){
          try{
            const kmlText = await zip.files[entryName].async("text");
            const virtualName = `${file.name}::${entryName}`;
            await addKmlFromText(virtualName, kmlText, saveOffline);
          }catch(e){
            logAct(`‚ùå ZIP entry failed ${entryName}: ${e.message}`, "bad");
          }
        }
      }catch(e){
        logAct(`‚ùå ZIP unzip failed (${file.name}): ${e.message}`, "bad");
      }
      continue;
    }

    logAct(`‚ö†Ô∏è Skipped unsupported file: ${file.name}`, "warn");
  }

  fitAll();
}

/* =========================
   Fetch ZIP from Drive (uses Proxy)
========================= */
async function fetchDriveZip(){
  const link = document.getElementById("kmlUrl").value.trim();
  const fid = extractDriveFileId(link);
  if(!fid){
    logAct("‚ùå Not a valid Drive file link", "bad");
    return;
  }

  const saveOffline = document.getElementById("saveOfflineChk").checked;

  const data = await fetchFromDriveViaProxy(fid);
  if(!data) return;

  const name = data.name || `drive_${fid}.zip`;
  const u8 = base64ToU8(data.base64 || "");

  const isZip =
    name.toLowerCase().endsWith(".zip") ||
    String(data.mimeType||"").toLowerCase().includes("zip") ||
    looksLikeZip(u8);

  if(!isZip){
    logAct("‚ö†Ô∏è Drive file is not ZIP (or proxy returned non-zip).", "warn");
  }

  try{
    logAct(`üóúÔ∏è ZIP received: ${name} (${u8.length} bytes)`, "ok");
    const zip = await JSZip.loadAsync(u8);

    const entries = Object.keys(zip.files);
    const kmlEntryNames = entries.filter(n => n.toLowerCase().endsWith(".kml") && !zip.files[n].dir);

    if(!kmlEntryNames.length){
      logAct("‚ö†Ô∏è ZIP contains no .kml files", "warn");
      return;
    }

    logAct(`‚úÖ Extracting ${kmlEntryNames.length} KML...`, "info");
    for(const entryName of kmlEntryNames){
      const kmlText = await zip.files[entryName].async("text");
      const virtualName = `${name}::${entryName}`;
      await addKmlFromText(virtualName, kmlText, saveOffline);
    }

    fitAll();
    logAct("‚úÖ Drive ZIP import done", "ok");
  }catch(e){
    logAct("‚ùå ZIP parse failed: " + e.message, "bad");
  }
}

/* =========================
   Load non-Drive URL (CORS must allow)
========================= */
async function loadNonDriveUrl(){
  const input = document.getElementById("kmlUrl").value.trim();
  if(!input){
    logAct("‚ùå URL is empty", "bad");
    return;
  }

  const saveOffline = document.getElementById("saveOfflineChk").checked;

  try{
    const res = await fetch(input);
    const buf = await res.arrayBuffer();
    const u8 = new Uint8Array(buf);

    const head = new TextDecoder("utf-8").decode(u8.slice(0, 200));
    if(head.includes("<!DOCTYPE html") || head.includes("ServiceLogin")){
      logAct("‚ùå Got HTML instead of file. Check URL/CORS.", "bad");
      return;
    }

    const name = (new URL(input)).pathname.split("/").pop() || "remote_file";

    if(looksLikeZip(u8) || name.toLowerCase().endsWith(".zip")){
      const zip = await JSZip.loadAsync(u8);
      const entries = Object.keys(zip.files);
      const kmlEntryNames = entries.filter(n => n.toLowerCase().endsWith(".kml") && !zip.files[n].dir);
      if(!kmlEntryNames.length){
        logAct("‚ö†Ô∏è ZIP contains no .kml", "warn");
        return;
      }
      for(const entryName of kmlEntryNames){
        const kmlText = await zip.files[entryName].async("text");
        const virtualName = `${name}::${entryName}`;
        await addKmlFromText(virtualName, kmlText, saveOffline);
      }
      fitAll();
      return;
    }

    const text = new TextDecoder("utf-8").decode(u8);
    await addKmlFromText(name.endsWith(".kml") ? name : (name + ".kml"), text, saveOffline);
    fitAll();
  }catch(e){
    logAct("‚ùå URL load failed: " + e.message, "bad");
  }
}

/* =========================
   Restore/Clear saved
========================= */
async function restoreSaved(){
  try{
    const saved = await idbGetAllKml();
    if(!saved.length){
      logAct("‚ÑπÔ∏è No saved KML found in offline storage", "info");
      return;
    }
    logAct(`üì¶ Restoring ${saved.length} saved KML...`, "info");

    for(const f of saved){
      if(kmlItems.some(x => x.name === f.name)) continue;
      await addKmlFromText(f.name, f.text, false);
    }
    fitAll();
    logAct("‚úÖ Restore complete", "ok");
  }catch(e){
    logAct("‚ùå Restore failed: " + e.message, "bad");
  }
}

async function clearSaved(){
  try{
    await idbClearAll();
    logAct("üßπ Offline saved KML cleared", "warn");
  }catch(e){
    logAct("‚ùå Clear saved failed: " + e.message, "bad");
  }
}

/* =========================
   Fit/Clear
========================= */
function fitAll(){
  if(boundaryLayer.getLayers().length){
    map.fitBounds(boundaryLayer.getBounds().pad(0.15));
    logAct("üîé Fit all boundaries", "info");
  }else{
    logAct("‚ö†Ô∏è Nothing to fit", "warn");
  }
}

function clearAll(){
  boundaryLayer.clearLayers();
  kmlItems.length = 0;
  updateCount();

  setText("insideVal", "‚Äî");
  setText("wbVal", "‚Äî");
  setText("bboxVal", "‚Äî");
  setTownIv("‚Äî","‚Äî");
  setDirText("No entry","No entry","No entry","No entry");

  logAct("üßπ Cleared all boundaries (map only)", "warn");
}

/* =========================
   Selection Actions
========================= */
function showSelected(){
  if(!sheetLoaded){
    logAct("‚ö†Ô∏è Load Sheet first", "warn");
    return;
  }

  const town = document.getElementById("townSel").value;
  const iv = document.getElementById("ivSel").value;
  const ward = document.getElementById("wardSel").value;
  const block = document.getElementById("blockSel").value;

  // Need ward+block for exact info
  if(!ward || !block){
    logAct("‚ö†Ô∏è Please select Ward and Block (Town/IV optional)", "warn");
    return;
  }

  const key = makeKey(ward, block);
  const row = sheetMap.get(key);

  if(row){
    setTownIv(row.town, row.iv);
    setDirText(row.north, row.east, row.south, row.west);
    setText("wbVal", `Ward w${row.ward} / Block b${row.block}`);
    setText("insideVal", "Selected (not GPS)");
    logAct(`üßæ Selected sheet row: ${key} (Town=${row.town||"-"}, IV=${row.iv||"-"})`, "ok");
  }else{
    setTownIv("‚Äî","‚Äî");
    setDirText("No entry","No entry","No entry","No entry");
    logAct(`‚ö†Ô∏è No sheet row for ${key}`, "warn");
  }

  const kmlHit = highlightByWardBlock(ward, block);
  if(kmlHit && kmlHit.bbox){
    const bb = kmlHit.bbox;
    setText("bboxVal", `N ${bb.N.toFixed(6)} | S ${bb.S.toFixed(6)} | E ${bb.E.toFixed(6)} | W ${bb.W.toFixed(6)}`);
  }else{
    setText("bboxVal", "‚Äî");
  }
}

function clearSelection(){
  document.getElementById("townSel").value = "";
  document.getElementById("ivSel").value = "";
  document.getElementById("wardSel").value = "";
  document.getElementById("blockSel").value = "";
  buildSelectionOptions();
  logAct("Selection cleared", "info");
}

/* =========================
   Persist inputs (proxy + drive link + autoFetch)
========================= */
const LS_PROXY="ufs_proxyUrl", LS_DRIVE="ufs_driveUrl", LS_AUTOFETCH="ufs_autoFetch";
function loadPrefs(){
  const p = localStorage.getItem(LS_PROXY); if(p) document.getElementById("proxyUrl").value = p;
  const d = localStorage.getItem(LS_DRIVE); if(d) document.getElementById("kmlUrl").value = d;
  const a = localStorage.getItem(LS_AUTOFETCH); if(a) document.getElementById("autoFetchChk").checked = (a==="1");
}
function savePrefs(){
  localStorage.setItem(LS_PROXY, document.getElementById("proxyUrl").value.trim());
  localStorage.setItem(LS_DRIVE, document.getElementById("kmlUrl").value.trim());
  localStorage.setItem(LS_AUTOFETCH, document.getElementById("autoFetchChk").checked ? "1":"0");
}

/* =========================
   Buttons + events
========================= */
document.getElementById("kmlInput").addEventListener("change", async (e) => {
  await handleKmlOrZipFiles(e.target.files);
  e.target.value = "";
});

document.getElementById("fetchDriveBtn").addEventListener("click", async () => {
  savePrefs();
  await fetchDriveZip();
});
document.getElementById("loadKmlUrlBtn").addEventListener("click", loadNonDriveUrl);

document.getElementById("restoreSavedBtn").addEventListener("click", restoreSaved);
document.getElementById("clearSavedBtn").addEventListener("click", clearSaved);

document.getElementById("loadSheetBtn").addEventListener("click", async () => {
  await loadSheet(0);
});

document.getElementById("startGpsBtn").addEventListener("click", startGPS);
document.getElementById("stopGpsBtn").addEventListener("click", stopGPS);

document.getElementById("detectNowBtn").addEventListener("click", () => {
  if(!lastPos){
    logAct("‚ö†Ô∏è No GPS fix yet. Start GPS first.", "warn");
    return;
  }
  logAct("üß≠ Detect Now clicked", "info");
  detectForLatLng(lastPos.lat, lastPos.lng);
});

document.getElementById("fitAllBtn").addEventListener("click", fitAll);
document.getElementById("clearBtn").addEventListener("click", clearAll);
document.getElementById("clearLogBtn").addEventListener("click", clearActivity);

document.getElementById("showSelectedBtn").addEventListener("click", showSelected);
document.getElementById("clearSelectionBtn").addEventListener("click", clearSelection);

["proxyUrl","kmlUrl","autoFetchChk"].forEach(id=>{
  document.getElementById(id).addEventListener("change", savePrefs);
});

["townSel","ivSel","wardSel","blockSel"].forEach(id=>{
  document.getElementById(id).addEventListener("change", () => {
    buildSelectionOptions();
  });
});

/* =========================
   Initial
========================= */
function setInit(){
  setGpsStatus(false);
  setSheetStatus(false, "Sheet: NOT LOADED");
  setSelStatus("Load Sheet first");
  logAct("Ready. 1) Restore/Upload KML/ZIP  2) Load Sheet  3) Start GPS or use Selection Console", "info");
}
setInit();

loadPrefs();

// Auto-restore saved KML on page open
restoreSaved();

// Optional: auto-fetch drive ZIP on open (ONLY if checked)
(async () => {
  if(document.getElementById("autoFetchChk").checked){
    const link = document.getElementById("kmlUrl").value.trim();
    const proxy = document.getElementById("proxyUrl").value.trim();
    if(link && proxy){
      logAct("üß© Auto-fetch enabled ‚Üí fetching Drive ZIP...", "info");
      try{ await fetchDriveZip(); }catch(e){ logAct("Auto-fetch failed: "+e.message, "bad"); }
    }else{
      logAct("‚ö†Ô∏è Auto-fetch checked but Proxy/Drive link missing", "warn");
    }
  }
})();
</script>
</body>
</html>