<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PLFS Gateway | NSO Scheme Hub 2026</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#020617; --panel:#0b1222; --card1:#0f172a; --card2:#111c33; --border:#22304a;
      --accent:#38bdf8; --green:#10b981; --amber:#f59e0b; --pink:#fb7185; --violet:#a78bfa;
      --text:#e5e7eb; --muted:#94a3b8;
      --shadow: 0 24px 90px rgba(0,0,0,.62);
      --shadow2: 0 18px 60px rgba(0,0,0,.45);
      --radius: 22px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    .bg{
      position:fixed; inset:0; z-index:-2;
      background:
        radial-gradient(1200px 520px at 18% 15%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(1000px 560px at 82% 22%, rgba(16,185,129,.12), transparent 60%),
        radial-gradient(900px 520px at 50% 85%, rgba(167,139,250,.10), transparent 65%),
        linear-gradient(180deg, #000814, #020617);
    }
    .noise{
      position:fixed; inset:0; z-index:-1;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      opacity:.16; mix-blend-mode:overlay; pointer-events:none;
    }
    .blob{
      position:fixed; width:420px; height:420px; border-radius:50%;
      filter: blur(50px); opacity:.22; z-index:-1;
      animation: float 9s ease-in-out infinite;
    }
    .b1{ left:-120px; top:80px; background: rgba(56,189,248,.8); }
    .b2{ right:-160px; top:140px; background: rgba(16,185,129,.8); animation-duration: 11s; }
    .b3{ left:38%; bottom:-220px; background: rgba(167,139,250,.8); animation-duration: 13s; }
    @keyframes float{
      0%,100%{ transform: translate(0,0) scale(1); }
      50%{ transform: translate(24px,-18px) scale(1.06); }
    }
    #fx{ position:fixed; inset:0; z-index:-0; pointer-events:none; opacity:.75; }

    .left-rail{
      position:fixed; inset:0 auto 0 0; width:72px;
      background:#0f172a; border-right:1px solid var(--border);
      display:flex; flex-direction:column; align-items:center;
      padding-top:14px; gap:18px; z-index:9999;
    }
    .left-rail a{
      width:56px; text-align:center; font-size:11px; font-weight:900;
      text-decoration:none; color:#fff; padding:8px 6px; border-radius:12px;
      line-height:1.2; transition:.2s ease;
    }
    .left-rail a:hover{ background:#1e293b; transform:translateX(2px); }
    .left-rail a.hub{ color:var(--accent); }
    .left-rail a.plfs{ color:var(--accent); }
    .left-rail a.action{ color:var(--green); }

    .wrap{ max-width:1240px; margin:0 auto; padding:56px 18px 90px; margin-left:72px; }

    .title{ margin:0; font-size:34px; font-weight:900; letter-spacing:.8px; line-height:1.05; }
    .title .a{ color: var(--accent); } .title .b{ color:#cbeeff; }
    .subtitle{ margin:10px 0 0; color:var(--muted); font-weight:600; font-size:14px; line-height:1.5; max-width:760px; }

    .badge-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(34,48,74,.9);
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-size:12px; font-weight:800; color:#dbeafe;
    }

    .spark{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(56,189,248,.65), transparent);
      opacity:.55;
      margin: 18px 0 0;
    }

    .section{ margin-top:22px; }
    .section-title{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 16px; border-radius:16px;
      border:1px solid rgba(34,48,74,.9);
      background: rgba(2,6,23,.45);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 40px rgba(0,0,0,.30);
    }
    .section-title .left{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px; color:#eaf6ff; }
    .section-title .left span{
      width:34px; height:34px; border-radius:12px; display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06);
    }
    .section-title .right{ font-size:12px; font-weight:800; color: rgba(148,163,184,.85); white-space:nowrap; }
    .section-divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(56,189,248,.45), transparent);
      opacity:.7; margin: 14px 0 18px;
    }

    .grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:22px; margin-top:18px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } .section-title .right{ display:none; } }

    .card{
      position:relative;
      border-radius: var(--radius);
      padding: 24px 24px 20px;
      background: linear-gradient(180deg, rgba(17,28,51,.92), rgba(15,23,42,.92));
      border: 1px solid rgba(34,48,74,.9);
      box-shadow: var(--shadow2);
      overflow:hidden;
      transform-style:preserve-3d;
      cursor: pointer;
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
    }
    .card::before{
      content:""; position:absolute; inset:-2px;
      background:
        radial-gradient(650px 260px at 15% 15%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(540px 240px at 88% 18%, rgba(16,185,129,.12), transparent 55%);
      opacity:.9; pointer-events:none;
    }
    .card::after{
      content:""; position:absolute; top:-40%; left:-60%;
      width:60%; height:180%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform: rotate(18deg);
      opacity:0; transition: opacity .35s ease;
      pointer-events:none;
    }
    .card:hover::after{ opacity:1; animation:sweep 1.2s ease; }
    @keyframes sweep{ 0%{ transform: translateX(0) rotate(18deg); } 100%{ transform: translateX(380%) rotate(18deg); } }
    .card:hover{ border-color: rgba(56,189,248,.55); box-shadow: var(--shadow); transform: translateY(-6px); }

    .card-head{ display:flex; align-items:center; gap:12px; position:relative; z-index:1; margin-bottom:10px; }
    .ico{
      width:42px; height:42px; border-radius:14px; display:grid; place-items:center; font-size:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .ico.action{ background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.26); }
    .ico.notes{ background: rgba(56,189,248,.12); border-color: rgba(56,189,248,.28); }

    .card h3{ margin:0; font-size:18px; font-weight:900; letter-spacing:.2px; }
    .card p{
      margin:6px 0 16px;
      color: var(--muted);
      font-weight:600;
      font-size:12.5px;
      line-height:1.5;
      position:relative; z-index:1;
    }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; position:relative; z-index:1; margin-top: 10px; }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding: 10px 14px; border-radius: 12px;
      font-weight:900; font-size:12px; letter-spacing:.3px;
      color:#001019; background: var(--accent);
      box-shadow: 0 18px 35px rgba(56,189,248,.18);
      display:inline-flex; align-items:center; gap:8px;
      text-decoration:none; user-select:none;
      transform: translateZ(25px);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    .btn:hover{ transform: translateZ(25px) translateY(-2px); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      color:#e5e7eb; border:1px solid rgba(255,255,255,.10);
      box-shadow:none;
    }
    .btn.secondary:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
    .btn.green{ background: var(--green); color:#00110a; box-shadow: 0 18px 35px rgba(16,185,129,.15); }
    .btn.violet{ background: var(--violet); color:#0b0620; box-shadow: 0 18px 35px rgba(167,139,250,.15); }

    .modalMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40000;
      padding:18px;
      backdrop-filter: blur(10px);
    }
    .modal{
      width:min(980px, 100%);
      max-height: 90vh;
      overflow:auto;
      background: linear-gradient(180deg, rgba(17,28,51,.96), rgba(15,23,42,.98));
      border:1px solid rgba(255,255,255,.10);
      border-radius:24px;
      box-shadow: var(--shadow);
    }
    .mh{
      padding:16px 16px 12px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:12px;
    }
    .mh .t{ font-weight:900; font-size:14px; }
    .xbtn{
      background:transparent;
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .mb{ padding:16px; }

    .form{ display:grid; gap:10px; position:relative; z-index:1; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 680px){ .row2{ grid-template-columns:1fr; } }

    label{
      font-size:11px; font-weight:900; color:var(--muted);
      letter-spacing:.2px; text-transform:uppercase;
    }
    .field{
      margin-top:6px; width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-weight:800;
      font-size:13px;
    }
    .field:focus{
      border-color:rgba(56,189,248,.55);
      box-shadow:0 0 0 3px rgba(56,189,248,.14);
    }

    .status{
      margin-top:10px;
      border:1px dashed rgba(255,255,255,.16);
      border-radius:18px;
      padding:12px;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      background:rgba(0,0,0,.18);
    }
    .progress{
      margin-top:10px;
      height:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(16,185,129,.95), rgba(56,189,248,.92));
      transition:width .2s ease;
    }

    .list{ margin-top:14px; display:grid; gap:10px; max-height: 360px; overflow:auto; padding-right:4px; }
    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
      background:rgba(0,0,0,.18);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .meta .a{ font-weight:900; font-size:12px; color:#fff; margin-bottom:6px; }
    .meta .b{ color:var(--muted); font-weight:800; font-size:11px; line-height:1.4; }
    .item a{ color:var(--accent); font-weight:900; text-decoration:none; font-size:12px; }
    .item a:hover{ text-decoration:underline; }

    /* multi preview */
    .previewWrap{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      background:rgba(0,0,0,.14);
      overflow:hidden;
    }
    .previewHead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:900;
      font-size:12px;
      color:#eaf6ff;
    }
    .previewBody{
      max-height:180px;
      overflow:auto;
      padding:6px 8px 10px;
      display:grid;
      gap:8px;
    }
    .prow{
      display:grid;
      grid-template-columns: 1.25fr .55fr .55fr;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background:rgba(255,255,255,.04);
    }
    .prow .fn{
      font-weight:900;
      font-size:11.5px;
      color:#fff;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .prow .sm{
      font-weight:900;
      font-size:11.5px;
      color:#dbeafe;
      text-align:center;
    }
    .prow .st{
      font-weight:900;
      font-size:11px;
      color:var(--muted);
      text-align:right;
      white-space:nowrap;
    }
    .tagOk{ color: rgba(16,185,129,.95); }
    .tagBad{ color: rgba(239,68,68,.95); }
  </style>
</head>

<body>
  <nav class="left-rail">
    <a href="index.html" class="hub">üè† HUB</a>
    <a href="plfs_gateway.html" class="plfs">üß≠ GATE</a>
    <a href="plfs.html" class="plfs">üìä PLFS</a>
    <a href="ufs_action.html" class="action">üìà Action</a>
  </nav>

  <div class="bg"></div>
  <canvas id="fx"></canvas>
  <div class="noise"></div>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <div class="wrap">
    <h1 class="title"><span class="a">PLFS</span> <span class="b">GATEWAY</span></h1>
    <p class="subtitle">
      Between HUB and PLFS: open <b>Action Plan</b> or upload <b>Inspection Notes (PDF)</b> SRO-wise with Sample No.
    </p>
    <div class="badge-row">
      <div class="pill">‚ö° Quick Access</div>
      <div class="pill">üìÑ PDF Notes</div>
      <div class="pill">‚òÅÔ∏è Firebase Sync</div>
      <div class="pill">üß† SRO-wise Tracking</div>
    </div>
    <div class="spark"></div>

    <div class="section">
      <div class="section-title">
        <div class="left"><span>üß≠</span><div>PLFS Gateway</div></div>
        <div class="right">Action Plan ‚Ä¢ Inspection Notes</div>
      </div>
      <div class="section-divider"></div>

      <div class="grid">
        <div class="card" role="button" onclick="go('plfs.html')">
          <div class="card-head">
            <div class="ico action">üìà</div>
            <h3>Action Plan</h3>
          </div>
          <p>Open PLFS command dashboard.</p>
          <div class="btnrow">
            <a class="btn secondary" href="plfs.html" onclick="event.stopPropagation()">üìä Go PLFS</a>
          </div>
        </div>

        <div class="card" role="button" onclick="openNotes()">
          <div class="card-head">
            <div class="ico notes">üìù</div>
            <h3>Inspection Notes (PDF)</h3>
          </div>
          <p>Upload PDF SRO-wise + Sample No (Auto detect from cover). PDFs go to Notes Storage, metadata to Notes RTDB.</p>
          <div class="btnrow">
            <button class="btn" type="button" onclick="event.stopPropagation(); openNotes()">‚¨ÜÔ∏è Upload Notes</button>
            <button class="btn secondary" type="button" onclick="event.stopPropagation(); loadRecent()">üîÑ Refresh</button>
          </div>

          <div class="status" style="margin-top:14px;">
            <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;">
              <div><b>Total Notes:</b> <span id="totalNotes">0</span></div>
              <div><b>Last Upload:</b> <span id="lastUpload">‚Äî</span></div>
            </div>
          </div>

          <div class="list" id="recentList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTES MODAL -->
  <div class="modalMask" id="notesMask" onclick="closeNotes(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mh">
        <div class="t">üìù Upload Inspection Notes (PDF) ‚Äî SRO wise + Sample No (Auto Detect)</div>
        <button class="xbtn" onclick="closeNotes()">‚úï Close</button>
      </div>
      <div class="mb">
        <div class="card" style="box-shadow:none; border-radius:18px; cursor:default;">
          <div class="card-head">
            <div class="ico notes">üìÑ</div>
            <h3>Upload Panel</h3>
          </div>
          <p>Select SRO, choose <b>one or multiple PDFs</b>. Sample No will be auto-detected from first page (manual allowed only for single PDF).</p>

          <div class="form">
            <div class="row2">
              <div>
                <label>Select SRO (Only 4)</label>
                <select id="sroSel" class="field" onchange="loadSroNotes()">
                  <option value="">‚Äî Select SRO ‚Äî</option>
                </select>
              </div>
              <div>
                <label>Sample No (manual only for single PDF)</label>
                <input id="sampleNo" class="field" placeholder="Auto-detected‚Ä¶ (single file: you may type)" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Inspection Date (optional)</label>
                <input id="insDate" type="date" class="field" />
              </div>
              <div>
                <label>Choose PDF File(s) (auto detect)</label>
                <input id="pdfFile" type="file" class="field" accept="application/pdf" multiple />
              </div>
            </div>

            <div>
              <label>Remarks (optional)</label>
              <input id="remarks" class="field" placeholder="Officer name / place etc." />
            </div>

            <div class="previewWrap">
              <div class="previewHead">
                <div>Selected Files Preview</div>
                <div style="color:var(--muted);font-size:11px;">Sample detect results</div>
              </div>
              <div class="previewBody" id="previewBody">
                <div class="status" style="margin:8px;">No file selected.</div>
              </div>
            </div>

            <div class="btnrow">
              <button class="btn green" id="uploadBtn" onclick="uploadPdf()">‚¨ÜÔ∏è Upload PDF(s)</button>
              <button class="btn secondary" onclick="resetForm()">üßπ Clear</button>
              <button class="btn violet" onclick="loadRecent()">üîÑ Refresh Recent</button>
            </div>

            <div class="progress"><div class="bar" id="progBar"></div></div>
            <div class="status" id="upStatus">Ready.</div>

            <div style="margin-top:14px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="font-weight:900;">SRO Notes List</div>
                <div style="color:var(--muted);font-weight:900;font-size:11px;">Click open to view/download</div>
              </div>
              <div class="list" id="sroList"></div>
            </div>
          </div>
        </div>

        <div class="status" style="margin-top:14px;">
          ‚úÖ Storage Path: <b>inspection_notes/{SRO}/sample_{SAMPLE}/SAMPLE_timestamp_filename.pdf</b><br/>
          ‚úÖ Notes RTDB Meta: <b>inspection_notes_meta/{SRO}/{noteId}</b> (stored in inspectionnote-default-rtdb)
        </div>
      </div>
    </div>
  </div>

<script>
/* ===================== NAV ===================== */
function go(url){ window.location.href = url; }

/* ===================== Firebase ===================== */
/* PRIMARY (existing PLFS project) */
const config = {
  apiKey: "AIzaSyB6fQ8n4qyG-TfVdAqWtDped17bMYTZSgI",
  authDomain: "action-plan-62fae.firebaseapp.com",
  databaseURL: "https://action-plan-62fae-default-rtdb.firebaseio.com",
  projectId: "action-plan-62fae",
  storageBucket: "action-plan-62fae.appspot.com"
};
firebase.initializeApp(config);
const db = firebase.database();

/* ‚úÖ SECOND (Inspection Notes separate RTDB + separate Storage) */
const notesConfig = {
  databaseURL: "https://inspection-notes-default-rtdb.firebaseio.com",
projectId: "inspection-notes",
storageBucket: "inspection-notes.appspot.com",
};
const notesApp = firebase.initializeApp(notesConfig, "notesApp");
const notesDb  = firebase.database(notesApp);
const notesStorage = firebase.storage(notesApp); // ‚úÖ IMPORTANT: use notes storage for PDFs

/* ===================== SRO list (ONLY 4) ===================== */
const ALLOWED_SROS = ["SRO SHIMLA","SRO HAMIRPUR","SRO DHARAMSHALA","SRO MANDI"];

/* ===================== Modal ===================== */
function openNotes(){
  document.getElementById("notesMask").style.display="flex";
  loadSroDropdownOnly4();
  loadRecent();
}
function closeNotes(e){
  if(e && e.target && e.target.id !== "notesMask") return;
  document.getElementById("notesMask").style.display="none";
}
function resetForm(){
  document.getElementById("sampleNo").value="";
  document.getElementById("insDate").value="";
  document.getElementById("pdfFile").value="";
  document.getElementById("remarks").value="";
  __lastDetectedSample = "";
  __lastDetectSource = "";
  __lastDetectSnippet = "";
  __multiDetected = [];
  renderPreview([]);
  setStatus("Ready.");
  setProgress(0);

  // upload default state
  const up = document.getElementById("uploadBtn");
  if(up) up.disabled = true;
}

/* ===================== helpers ===================== */
function setProgress(p){
  document.getElementById("progBar").style.width = `${Math.max(0, Math.min(100, p))}%`;
}
function setStatus(msg, type="info"){
  const el = document.getElementById("upStatus");
  el.innerHTML = msg;
  el.style.borderColor =
    type==="ok" ? "rgba(16,185,129,.6)" :
    type==="bad" ? "rgba(239,68,68,.6)" :
    "rgba(255,255,255,.16)";
}
function safeKey(s){ return String(s||"").replace(/[.#$[\]/]/g,"_"); }
function safeSample(s){ return String(s||"").replace(/[^\w\-]/g,"_"); }
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ===================== Preview ===================== */
function renderPreview(files){
  const box = document.getElementById("previewBody");
  if(!files || !files.length){
    box.innerHTML = `<div class="status" style="margin:8px;">No file selected.</div>`;
    return;
  }
  box.innerHTML = files.map(f=>{
    const has = !!(f.sample && String(f.sample).trim());
    const st = has ? `<span class="tagOk">OK</span>` : `<span class="tagBad">NOT FOUND</span>`;
    const sm = has ? escapeHtml(f.sample) : "‚Äî";
    return `
      <div class="prow">
        <div class="fn" title="${escapeHtml(f.name)}">${escapeHtml(f.name)}</div>
        <div class="sm">${sm}</div>
        <div class="st">${st}${f.source ? ` ‚Ä¢ ${escapeHtml(f.source)}` : ""}</div>
      </div>
    `;
  }).join("");
}

/* ===================== Sample detection (PDF.js + OCR) ===================== */
let __lastDetectedSample = "";
let __lastDetectSource = "";
let __lastDetectSnippet = "";
let __multiDetected = []; // [{name,size,sample,source,snippet}]

function extractSampleFromText(txt){
  const t = String(txt || "");
  const cleaned = t.replace(/\s+/g," ").trim();

  // strong
  const p1 = /S\.?\s*No\.?\s*of\s*(the\s*)?sample\s*FSU\s*[:\-]?\s*([0-9]{4,10})/i;
  let m = cleaned.match(p1);
  if(m) return { sample: m[2], snippet: m[0] };

  // generic
  const p2 = /(sample\s*(serial|s\.?no|no\.?|number|id)|serial\s*no\.?|s\.?\s*no\.?)\s*[:\-]?\s*([A-Z0-9\-\/]{2,30})/i;
  m = cleaned.match(p2);
  if(m) return { sample: m[3], snippet: m[0] };

  // fsu near number
  const p3 = /FSU[^0-9]{0,24}([0-9]{4,10})/i;
  m = cleaned.match(p3);
  if(m) return { sample: m[1], snippet: m[0] };

  return null;
}

async function detectSampleFromPdf_RETURN(file){
  try{
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    const page = await pdf.getPage(1);

    // 1) text extraction
    let text = "";
    try{
      const tc = await page.getTextContent();
      text = (tc.items || []).map(x => x.str || "").join(" ").trim();
    }catch(e){}

    const found1 = extractSampleFromText(text);
    if(found1 && found1.sample){
      return { sample: String(found1.sample), source: "pdf-text", snippet: found1.snippet || "" };
    }

    // 2) OCR (scanned)
    const viewport = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently:true });
    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);

    await page.render({ canvasContext: ctx, viewport }).promise;

    const dataUrl = canvas.toDataURL("image/png");
    const ocr = await Tesseract.recognize(dataUrl, "eng");
    const ocrText = (ocr && ocr.data && ocr.data.text) ? ocr.data.text : "";

    const found2 = extractSampleFromText(ocrText);
    if(found2 && found2.sample){
      return { sample: String(found2.sample), source: "ocr", snippet: found2.snippet || "" };
    }

    return { sample: "", source: "", snippet: "" };
  }catch(err){
    console.error("detectSampleFromPdf_RETURN error:", err);
    return { sample: "", source: "error", snippet: String(err.message || err) };
  }
}

async function detectSampleFromPdf(file){
  if(!file) return;
  setStatus("üîé Detecting Sample No from PDF cover‚Ä¶", "info");
  setProgress(5);

  const det = await detectSampleFromPdf_RETURN(file);
  if(det && det.sample){
    __lastDetectedSample = String(det.sample);
    __lastDetectSource = det.source || "";
    __lastDetectSnippet = det.snippet || "";
    const inp = document.getElementById("sampleNo");
    if(!inp.value.trim()) inp.value = __lastDetectedSample;
    setStatus(`‚úÖ Sample No detected: <b>${escapeHtml(__lastDetectedSample)}</b> (${escapeHtml(__lastDetectSource)})`, "ok");
    setProgress(70);
    return true;
  }else{
    setStatus("‚ö†Ô∏è Sample No not found on cover. Please type manually (single file only).", "bad");
    setProgress(0);
    return false;
  }
}

/* ===================== Load SRO dropdown (ONLY 4) ===================== */
function loadSroDropdownOnly4(){
  const sel = document.getElementById("sroSel");
  const prev = sel.value || "";
  sel.innerHTML = `<option value="">‚Äî Select SRO ‚Äî</option>`;
  ALLOWED_SROS.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
  if(prev && ALLOWED_SROS.includes(prev)) sel.value = prev;
  if(sel.value) loadSroNotes();
}

/* ===================== Upload PDF(s): Notes Storage + Notes RTDB meta ===================== */
async function uploadPdf(){
  const sro = document.getElementById("sroSel").value.trim();
  const insDate = document.getElementById("insDate").value || "";
  const remarks = document.getElementById("remarks").value.trim();
  const fileEl = document.getElementById("pdfFile");
  const files = Array.from(fileEl.files || []);

  if(!sro) { setStatus("‚ùå Please select SRO.", "bad"); return; }
  if(!files.length){ setStatus("‚ùå Please choose PDF file(s).", "bad"); return; }
  for(const f of files){
    if(f.type !== "application/pdf"){
      setStatus(`‚ùå Only PDF allowed. Invalid: ${escapeHtml(f.name)}`, "bad");
      return;
    }
  }

  const btn = document.getElementById("uploadBtn");
  btn.disabled = true;
  setProgress(0);

  try{
    const sroKey = safeKey(sro);
    const tsBase = Date.now();
    const manualSample = document.getElementById("sampleNo").value.trim();

    // if multi file, ensure detection finished
    if(files.length > 1 && (!__multiDetected || __multiDetected.length !== files.length)){
      setStatus("‚ö†Ô∏è Please wait for detection to finish (or reselect files).", "bad");
      btn.disabled = false;
      return;
    }

    let okCount = 0, failCount = 0;

    for(let i=0;i<files.length;i++){
      const file = files[i];
      const ts = tsBase + i;

      let sample = "", detectSource = "", detectSnippet = "", sampleAuto = false;

      if(files.length === 1){
        if(manualSample){
          sample = manualSample; sampleAuto = false;
        }else if(__lastDetectedSample){
          sample = __lastDetectedSample;
          detectSource = __lastDetectSource || "";
          detectSnippet = __lastDetectSnippet || "";
          sampleAuto = true;
        }else{
          setStatus(`üîé Detecting Sample No: <b>${escapeHtml(file.name)}</b>`, "info");
          const det = await detectSampleFromPdf_RETURN(file);
          sample = det.sample || "";
          detectSource = det.source || "";
          detectSnippet = det.snippet || "";
          sampleAuto = !!sample;
        }
      }else{
        const det = __multiDetected[i] || {};
        sample = (det.sample || "").trim();
        detectSource = det.source || "";
        detectSnippet = det.snippet || "";
        sampleAuto = !!sample;
      }

      if(!sample){
        failCount++;
        setStatus(`‚ùå Sample No not found for: <b>${escapeHtml(file.name)}</b> (skip)`, "bad");
        continue;
      }

      setStatus(`‚¨ÜÔ∏è Uploading (${i+1}/${files.length}): <b>${escapeHtml(file.name)}</b> | Sample: <b>${escapeHtml(sample)}</b>`, "info");

      const sampleKey = safeSample(sample);
      const safeName = (file.name || "notes.pdf").replace(/[^\w.\-]/g,"_");
      const storagePath = `inspection_notes/${sroKey}/sample_${sampleKey}/${sampleKey}_${ts}_${safeName}`;

      // ‚úÖ IMPORTANT: upload to NOTES storage
      const ref = notesStorage.ref(storagePath);
      const task = ref.put(file, { contentType:"application/pdf" });

      await new Promise((resolve, reject)=>{
        task.on("state_changed", (snap)=>{
          const base = (i / files.length) * 100;
          const local = (snap.bytesTransferred / snap.totalBytes) * (100 / files.length);
          setProgress(Math.min(99, base + local));
        }, reject, resolve);
      });

      const url = await ref.getDownloadURL();

      const noteId = `${ts}_${Math.random().toString(16).slice(2)}`;
      const meta = {
        sro,
        sampleNo: sample,
        sampleAutoDetected: sampleAuto,
        sampleDetectSource: detectSource,
        sampleDetectSnippet: detectSnippet,
        inspectionDate: insDate,
        remarks,
        fileName: file.name,
        storagePath,
        url,
        createdAt: ts
      };

      await notesDb.ref(`inspection_notes_meta/${sroKey}/${noteId}`).set(meta);
      okCount++;
    }

    setProgress(100);
    setStatus(`‚úÖ Upload completed. Success: <b>${okCount}</b> | Failed/Skipped: <b>${failCount}</b>`, okCount ? "ok" : "bad");

    await loadSroNotes();
    await loadRecent();

    // reset after upload
    fileEl.value = "";
    document.getElementById("sampleNo").value = "";
    __multiDetected = [];
    __lastDetectedSample = "";
    __lastDetectSource = "";
    __lastDetectSnippet = "";
    renderPreview([]);

  }catch(err){
    console.error(err);
    setStatus(`‚ùå Upload failed: ${escapeHtml(err.message || err)}`, "bad");
    setProgress(0);
  }finally{
    btn.disabled = false;
  }
}

/* ===================== Load notes list for selected SRO (Notes RTDB) ===================== */
async function loadSroNotes(){
  const sro = document.getElementById("sroSel").value.trim();
  const box = document.getElementById("sroList");
  box.innerHTML = "";

  if(!sro){
    box.innerHTML = `<div class="status">Select SRO to view uploads.</div>`;
    return;
  }

  const sroKey = safeKey(sro);

  try{
    const snap = await notesDb.ref(`inspection_notes_meta/${sroKey}`)
      .orderByChild("createdAt").limitToLast(60).once("value");

    if(!snap.exists()){
      box.innerHTML = `<div class="status">No notes uploaded for this SRO yet.</div>`;
      return;
    }

    const arr = [];
    snap.forEach(ch => arr.push({ id: ch.key, ...ch.val() }));
    arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));

    box.innerHTML = arr.map(n=>{
      const dt = n.createdAt ? new Date(n.createdAt).toLocaleString() : "‚Äî";
      const idate = n.inspectionDate ? n.inspectionDate : "‚Äî";
      const sample = n.sampleNo || "‚Äî";
      const rmk = n.remarks ? n.remarks : "‚Äî";
      const badge = n.sampleAutoDetected ? "üß† Auto" : "‚úçÔ∏è Manual";

      return `
        <div class="item">
          <div class="meta">
            <div class="a">Sample No: ${escapeHtml(sample)} ‚Ä¢ ${escapeHtml(n.fileName || "PDF")}
              <span style="color:var(--muted);font-weight:900;">(${badge})</span>
            </div>
            <div class="b">Inspection Date: <b style="color:#fff">${escapeHtml(idate)}</b><br/>
              Uploaded: ${escapeHtml(dt)}<br/>Remarks: ${escapeHtml(rmk)}
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
            <a href="${n.url}" target="_blank" rel="noopener">Open PDF ‚Üó</a>
          </div>
        </div>
      `;
    }).join("");
  }catch(err){
    console.error(err);
    box.innerHTML = `<div class="status" style="border-color:rgba(239,68,68,.6)">‚ùå Failed: ${escapeHtml(err.message || err)}</div>`;
  }
}

/* ===================== Recent list (all SRO) Notes RTDB ===================== */
async function loadRecent(){
  const recentBox = document.getElementById("recentList");
  recentBox.innerHTML = `<div class="status">Loading‚Ä¶</div>`;

  try{
    const root = await notesDb.ref("inspection_notes_meta").once("value");
    let all = [];

    if(root.exists()){
      root.forEach(sroNode=>{
        const obj = sroNode.val() || {};
        Object.values(obj).forEach(n=>{
          if(n && n.createdAt) all.push(n);
        });
      });
    }

    all.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
    const top = all.slice(0, 8);

    document.getElementById("totalNotes").textContent = all.length ? String(all.length) : "0";
    document.getElementById("lastUpload").textContent = top.length ? new Date(top[0].createdAt).toLocaleString() : "‚Äî";

    if(!top.length){
      recentBox.innerHTML = `<div class="status">No uploads yet.</div>`;
      return;
    }

    recentBox.innerHTML = top.map(n=>{
      const dt = new Date(n.createdAt).toLocaleString();
      return `
        <div class="item">
          <div class="meta">
            <div class="a">${escapeHtml(n.sro || "SRO")} ‚Ä¢ Sample: ${escapeHtml(n.sampleNo || "‚Äî")}</div>
            <div class="b">${escapeHtml(n.fileName || "PDF")}<br/>${escapeHtml(dt)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
            <a href="${n.url}" target="_blank" rel="noopener">Open ‚Üó</a>
          </div>
        </div>
      `;
    }).join("");

  }catch(err){
    console.error(err);
    recentBox.innerHTML = `<div class="status" style="border-color:rgba(239,68,68,.6)">‚ùå Failed: ${escapeHtml(err.message || err)}</div>`;
  }
}

/* ===================== FX: particles ===================== */
const c = document.getElementById('fx');
const ctx = c.getContext('2d');
let W,H,particles=[];

function resize(){
  W = c.width = window.innerWidth;
  H = c.height = window.innerHeight;
  particles = Array.from({length: 70}, () => ({
    x: Math.random()*W, y: Math.random()*H,
    r: Math.random()*1.6 + 0.4,
    vx: (Math.random()*0.6 + 0.2) * (Math.random()<0.5?-1:1),
    vy: (Math.random()*0.6 + 0.2) * (Math.random()<0.5?-1:1),
    a: Math.random()*0.35 + 0.15
  }));
}
window.addEventListener('resize', resize);
resize();

function draw(){
  ctx.clearRect(0,0,W,H);
  for(const p of particles){
    p.x += p.vx; p.y += p.vy;
    if(p.x < -20) p.x = W+20;
    if(p.x > W+20) p.x = -20;
    if(p.y < -20) p.y = H+20;
    if(p.y > H+20) p.y = -20;

    ctx.beginPath();
    ctx.globalAlpha = p.a;
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = "#cbeeff";
    ctx.fill();
  }

  for(let i=0;i<particles.length;i++){
    for(let j=i+1;j<particles.length;j++){
      const a = particles[i], b = particles[j];
      const dx = a.x-b.x, dy = a.y-b.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < 140){
        ctx.globalAlpha = (1 - dist/140) * 0.18;
        ctx.strokeStyle = "#38bdf8";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(a.x,a.y);
        ctx.lineTo(b.x,b.y);
        ctx.stroke();
      }
    }
  }
  ctx.globalAlpha = 1;
  requestAnimationFrame(draw);
}
draw();

/* ===================== hover tilt ===================== */
document.querySelectorAll('.card').forEach(card=>{
  let rect=null;
  card.addEventListener('mousemove', (e)=>{
    rect = rect || card.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const cx = rect.width/2;
    const cy = rect.height/2;
    const rx = ((y - cy)/cy) * -5;
    const ry = ((x - cx)/cx) * 6;
    card.style.transform = `translateY(-6px) rotateX(${rx}deg) rotateY(${ry}deg)`;
  });
  card.addEventListener('mouseleave', ()=>{
    rect=null;
    card.style.transform = '';
  });
});

/* ===================== Boot ===================== */
window.onload = () => {
  loadRecent();
  renderPreview([]);
  loadSroDropdownOnly4();

  // by default: no file selected -> upload disabled
  const up = document.getElementById("uploadBtn");
  if(up) up.disabled = true;

  const f = document.getElementById("pdfFile");
  if(f){
    f.addEventListener("change", async ()=>{
      const files = Array.from(f.files || []);
      __multiDetected = [];
      __lastDetectedSample = "";
      __lastDetectSource = "";
      __lastDetectSnippet = "";

      // disable upload while detecting
      if(up) up.disabled = true;

      if(!files.length){
        renderPreview([]);
        setStatus("Ready.");
        setProgress(0);
        return;
      }

      // placeholder preview
      renderPreview(files.map(x=>({name:x.name, sample:"", source:""})));
      setStatus(`üîé Detecting Sample No for ${files.length} PDF(s)‚Ä¶`, "info");
      setProgress(2);

      // detect sequential for stability
      for(let i=0;i<files.length;i++){
        const file = files[i];
        setStatus(`üîé Detecting (${i+1}/${files.length}) : <b>${escapeHtml(file.name)}</b>`, "info");

        const det = await detectSampleFromPdf_RETURN(file);

        __multiDetected.push({
          name: file.name,
          size: file.size,
          sample: det.sample || "",
          source: det.source || "",
          snippet: det.snippet || ""
        });

        renderPreview(__multiDetected.map(x=>({name:x.name, sample:x.sample, source:x.source})));
        const pct = Math.round(((i+1)/files.length)*60);
        setProgress(Math.min(60, pct));
      }

      // single file auto-fill
      if(files.length === 1){
        const one = __multiDetected[0];
        if(one && one.sample && !document.getElementById("sampleNo").value.trim()){
          document.getElementById("sampleNo").value = one.sample;
          __lastDetectedSample = one.sample;
          __lastDetectSource = one.source;
          __lastDetectSnippet = one.snippet;
        }else{
          await detectSampleFromPdf(files[0]);
        }
      }

      const found = __multiDetected.filter(x=>x.sample).length;
      setStatus(`‚úÖ Detection done. Found Sample No in <b>${found}/${files.length}</b> file(s). Now click Upload.`, found? "ok" : "bad");
      setProgress(65);

      // enable upload after detection (even if 0 found - still allow single file manual)
      if(up){
        if(files.length === 1) up.disabled = false;
        else up.disabled = false; // multi allowed; files without sample will be skipped
      }
    });
  }
};
</script>
</body>
</html>
