<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>PLFS | Command Dashboard 2026</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617; --panel:#0b1222; --panel2:#0f172a; --card:#111c33;
      --border:#22304a; --border2:#334155;
      --accent:#38bdf8; --green:#10b981; --amber:#f59e0b; --danger:#ef4444;
      --muted:#94a3b8; --text:#f8fafc;
      --shadow: 0 24px 90px rgba(0,0,0,.62);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Arial,sans-serif;
      background:
        radial-gradient(900px 420px at 20% 10%, rgba(56,189,248,.14), transparent 55%),
        radial-gradient(800px 400px at 90% 20%, rgba(16,185,129,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height:100vh;
      gap:14px;
      padding:14px;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(17,28,51,.88), rgba(11,18,34,.88));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: calc(100vh - 28px);
    }
    .sb-top{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(34,48,74,.7);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(circle at 30% 25%, rgba(56,189,248,.9), rgba(56,189,248,.2));
      border:1px solid rgba(56,189,248,.35);
      box-shadow:0 10px 30px rgba(56,189,248,.15);
    }
    .brand h1{ font-size:14px; margin:0; font-weight:900; letter-spacing:.2px; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .sb-actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid rgba(56,189,248,.28);
      background: rgba(56,189,248,.10);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.5); }
    .btn.secondary{ border:1px solid rgba(148,163,184,.25); background: rgba(148,163,184,.08); }
    .btn.danger{ border:1px solid rgba(239,68,68,.30); background: rgba(239,68,68,.12); }

    .sb-scroll{ padding:12px; overflow:auto; flex:1; }
    .zone-title{
      font-size:12px; font-weight:900; color:rgba(226,232,240,.9);
      margin:14px 4px 8px; letter-spacing:.35px; text-transform:uppercase;
    }
    .state-grid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .st-btn{
      background: rgba(2,6,23,.35);
      border:1px solid rgba(51,65,85,.35);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition:.15s ease;
      position:relative;
      overflow:hidden;
    }
    .st-btn:hover{ border-color: rgba(56,189,248,.35); transform: translateY(-1px); }
    .st-btn.active{
      border-color: rgba(56,189,248,.55);
      background: rgba(56,189,248,.10);
      box-shadow: 0 16px 40px rgba(56,189,248,.08);
    }
    .st-btn.has-data::after{
      content:"";
      position:absolute; top:12px; right:12px;
      width:8px; height:8px; border-radius:50%;
      background: var(--green);
      box-shadow:0 0 0 4px rgba(16,185,129,.12);
    }
    .st-btn > div{ font-size:13px; font-weight:800; }

    .sub-menu-container{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px dashed rgba(148,163,184,.25);
      background: rgba(2,6,23,.35);
    }
    .pill-grid{ display:flex; flex-wrap:wrap; gap:8px; }
    .month-grid{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:10px; padding-top:10px;
      border-top:1px solid rgba(51,65,85,.35);
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      border:1px solid rgba(51,65,85,.45);
      background: rgba(15,23,42,.55);
      transition:.15s ease;
      user-select:none;
    }
    .pill:hover{ border-color: rgba(56,189,248,.35); transform: translateY(-1px); }
    .pill.active{ border-color: rgba(56,189,248,.6); background: rgba(56,189,248,.14); }
    .pill.all-btn{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); }

    /* Main */
    .main{
      background: linear-gradient(180deg, rgba(11,18,34,.86), rgba(15,23,42,.86));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
    }
    .topbar{
      padding:14px 16px;
      border-bottom:1px solid rgba(34,48,74,.7);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title-block h2{ margin:0; font-size:16px; font-weight:900; }
    .title-block p{ margin:4px 0 0; font-size:12px; color:var(--muted); font-weight:600; }
    .top-controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid rgba(51,65,85,.45);
      background: rgba(2,6,23,.35);
      color:rgba(226,232,240,.95);
      display:flex; gap:8px; align-items:center;
    }
    .chip b{ color: var(--text); }

    .content{ padding:14px; overflow:auto; flex:1; }
    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }

    .card{
      grid-column: span 3;
      background: rgba(17,28,51,.60);
      border:1px solid rgba(51,65,85,.35);
      border-radius:16px;
      padding:14px;
    }
    .card h3{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.25px;
      text-transform:uppercase;
    }
    .card .big{ margin-top:6px; font-size:22px; font-weight:900; letter-spacing:.2px; }
    .card .sub{ margin-top:6px; font-size:12px; color:rgba(226,232,240,.85); font-weight:700; }

    .card.wide{ grid-column: span 12; padding:0; overflow:hidden; }
    .table-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(51,65,85,.35);
    }
    .table-head .left{ display:flex; flex-direction:column; gap:3px; }
    .table-head .left .t1{ font-weight:900; font-size:13px; }
    .table-head .left .t2{ font-size:12px; color:var(--muted); font-weight:700; }
    .table-actions{ display:flex; gap:10px; flex-wrap:wrap; }

    .table-wrap{ overflow:auto; max-height: calc(100vh - 360px); }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:12px;
      background: rgba(2,6,23,.15);
    }
    thead th{
      position:sticky; top:0; z-index:2;
      background: rgba(15,23,42,.95);
      border-bottom:1px solid rgba(51,65,85,.6);
      color:rgba(226,232,240,.95);
      padding:10px 8px;
      font-weight:900;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      padding:9px 8px;
      border-bottom:1px solid rgba(51,65,85,.25);
      color:rgba(226,232,240,.92);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    tbody tr:hover{ background: rgba(56,189,248,.07); }
    .right{text-align:right}
    .center{text-align:center}

    .footer{
      padding:10px 14px;
      border-top:1px solid rgba(34,48,74,.7);
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:99;
    }
    .modal{
      width:min(520px, 96vw);
      background: rgba(15,23,42,.96);
      border:1px solid rgba(51,65,85,.55);
      border-radius:18px;
      box-shadow:0 30px 120px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modal-h{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(51,65,85,.35);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modal-h b{ font-size:14px; font-weight:900; }
    .modal-c{ padding:14px; }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .field label{ font-size:12px; color:var(--muted); font-weight:800; }
    .field input{
      height:42px; border-radius:12px; padding:0 12px;
      border:1px solid rgba(51,65,85,.5);
      background: rgba(2,6,23,.35);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; padding:0 14px 14px; }

    @media(max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ min-height:auto; }
      .table-wrap{ max-height: 55vh; }
      .card{ grid-column: span 6; }
    }
    @media(max-width: 560px){
      .card{ grid-column: span 12; }
      thead th, tbody td{ font-size:11px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>PLFS | Dashboard 2026</h1>
            <p>State ‚Üí SRO ‚Üí Month filters (fixed)</p>
          </div>
        </div>
        <div class="sb-actions">
          <button class="btn" onclick="autoFetch(true)">üîÑ Refresh</button>
          <button class="btn secondary" onclick="openAuth()">üîê Login</button>
          <button class="btn secondary" onclick="openImport()">üì• Import</button>
          <button class="btn danger" onclick="hardReset()">üßπ Reset</button>
        </div>
      </div>
      <div class="sb-scroll" id="navScroll"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title-block">
          <h2 id="pageTitle">PLFS Progress</h2>
          <p id="pageSub">Live data + filters + export + import</p>
        </div>
        <div class="top-controls">
          <div class="chip">State: <b id="chipState">‚Äî</b></div>
          <div class="chip">SRO: <b id="chipSro">‚Äî</b></div>
          <div class="chip">Month: <b id="chipMonth">‚Äî</b></div>
          <div class="chip">Role: <b id="chipRole">Guest</b></div>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="card">
            <h3>Total Records</h3>
            <div class="big" id="kpiRecords">0</div>
            <div class="sub" id="kpiRecordsSub">Filtered rows</div>
          </div>
          <div class="card">
            <h3>Sum Target</h3>
            <div class="big" id="kpiTarget">0</div>
            <div class="sub">Auto-sum numeric fields</div>
          </div>
          <div class="card">
            <h3>Sum Achievement</h3>
            <div class="big" id="kpiAch">0</div>
            <div class="sub">Auto-sum numeric fields</div>
          </div>
          <div class="card">
            <h3>% Achievement</h3>
            <div class="big" id="kpiPct">0%</div>
            <div class="sub">Ach / Target</div>
          </div>

          <div class="card wide">
            <div class="table-head">
              <div class="left">
                <div class="t1">Monthly Table</div>
                <div class="t2" id="tableHint">Use sidebar filters. Export anytime.</div>
              </div>
              <div class="table-actions">
                <button class="btn secondary" onclick="exportCSV()">‚¨áÔ∏è CSV</button>
                <button class="btn secondary" onclick="exportXLSX()">‚¨áÔ∏è Excel</button>
              </div>
            </div>
            <div class="table-wrap">
              <table id="dataTable">
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>Cache: <span id="cacheStatus">‚Äî</span></div>
        <div id="lastSync">Last Sync: ‚Äî</div>
      </div>
    </main>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal-backdrop" id="authBackdrop">
    <div class="modal">
      <div class="modal-h">
        <b>Login (for SRO selection)</b>
        <button class="btn secondary" onclick="closeAuth()">‚úï</button>
      </div>
      <div class="modal-c">
        <div class="field">
          <label>User ID</label>
          <input id="authUser" placeholder="e.g. JSO3_0209002" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="authPass" type="password" placeholder="e.g. nrsc123" />
        </div>
        <div class="field">
          <label>Role</label>
          <input id="authRole" placeholder="ADMIN / USER" />
        </div>
        <div style="font-size:12px;color:var(--muted);font-weight:700;">
          Tip: If role is ADMIN, you can select any SRO. Otherwise only ALL SRO's.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="doLogin()">‚úÖ Save</button>
        <button class="btn secondary" onclick="closeAuth()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- IMPORT MODAL -->
  <div class="modal-backdrop" id="importBackdrop">
    <div class="modal">
      <div class="modal-h">
        <b>Import Excel</b>
        <button class="btn secondary" onclick="closeImport()">‚úï</button>
      </div>
      <div class="modal-c">
        <div class="field">
          <label>Select Excel file</label>
          <input id="importFile" type="file" accept=".xlsx,.xls" />
        </div>
        <div style="font-size:12px;color:var(--muted);font-weight:700;">
          Import updates cache + table. If your Excel headers differ, edit <b>mapImportedRow()</b>.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="importExcel()">üì• Import</button>
        <button class="btn secondary" onclick="closeImport()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * 1) CONFIG
     **********************/
    const firebaseConfig = {
      // ‚úÖ PUT YOUR REAL CONFIG HERE
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ‚úÖ PUT YOUR REAL NODE PATH HERE (example: "PLFS_2026/master")
    const DB_PATH = "PLFS_2026/master";

    // You wanted HP only
    const nsoZones = { "NORTH": ["HIMACHAL PRADESH"] };

    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    /**********************
     * 2) STATE
     **********************/
    let master = [];
    let filtered = [];

    let selSt = "";
    let selSro = "ALL SROs";
    let selMo = new Date().getMonth();

    let auth = { user:"", role:"GUEST" };

    const columns = [
      { key:"state",  label:"State",    w:160 },
      { key:"sro",    label:"SRO",      w:140 },
      { key:"month",  label:"Month",    w:90  },
      { key:"district", label:"District", w:160 },
      { key:"unit",   label:"Unit",     w:140 },
      { key:"target", label:"Target",   w:90,  num:true },
      { key:"ach",    label:"Ach",      w:90,  num:true },
      { key:"remarks",label:"Remarks",  w:240 }
    ];

    /**********************
     * 3) NORMALIZERS (FIX)
     **********************/
    function normState(s){
      return String(s||"").trim().toUpperCase().replace(/_/g," ").replace(/\s+/g," ");
    }
    function normSro(s){
      return String(s||"").trim().toUpperCase().replace(/\s+/g," ");
    }
    function safeNum(v){
      const n = Number(String(v||"").replace(/,/g,"").trim());
      return isFinite(n) ? n : 0;
    }

    /**********************
     * 4) CACHE
     **********************/
    const CACHE_KEY = "PLFS_MASTER_CACHE_V1";
    const CACHE_META = "PLFS_MASTER_CACHE_META_V1";

    function setCache(data){
      localStorage.setItem(CACHE_KEY, JSON.stringify(data||[]));
      localStorage.setItem(CACHE_META, JSON.stringify({ts: Date.now(), count: (data||[]).length}));
      updateCacheBadge();
    }
    function getCache(){
      try{ return JSON.parse(localStorage.getItem(CACHE_KEY) || "[]"); }
      catch(e){ return []; }
    }
    function getCacheMeta(){
      try{ return JSON.parse(localStorage.getItem(CACHE_META) || "{}"); }
      catch(e){ return {}; }
    }
    function updateCacheBadge(){
      const meta = getCacheMeta();
      const el = document.getElementById("cacheStatus");
      if(!meta.ts){ el.textContent = "No cache"; return; }
      const dt = new Date(meta.ts);
      el.textContent = `Saved (${meta.count||0}) @ ${dt.toLocaleString()}`;
    }

    /**********************
     * 5) FIREBASE
     **********************/
    let db = null;
    function initFirebase(){
      try{
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.database();
      }catch(e){ console.warn("Firebase init failed:", e); }
    }

    async function autoFetch(force=false){
      initFirebase();

      // show cache fast
      if(!force){
        const cached = getCache();
        if(cached.length){
          master = cached;
          bootAfterDataLoad();
        }
      }
      if(!db) return;

      try{
        const snap = await db.ref(DB_PATH).once("value");
        const val = snap.val();
        const list = [];

        if(val && typeof val === "object"){
          for(const k of Object.keys(val)){
            const row = val[k];
            if(row && typeof row === "object") list.push(mapDbRow(row, k));
          }
        }
        if(list.length){
          master = list;
          setCache(master);
          document.getElementById("lastSync").textContent = `Last Sync: ${new Date().toLocaleString()}`;
          bootAfterDataLoad();
        }
      }catch(err){
        console.warn("Fetch error:", err);
      }
    }

    function mapDbRow(row, id){
      return {
        _id: id || row.id || "",
        state: row.state ?? row.State ?? row.STATE ?? "HIMACHAL PRADESH",
        sro: row.sro ?? row.SRO ?? row.office ?? "RO SHIMLA",
        month: row.month ?? row.Month ?? row.mo ?? months[selMo],
        district: row.district ?? row.District ?? "",
        unit: row.unit ?? row.Unit ?? "",
        target: row.target ?? row.Target ?? 0,
        ach: row.ach ?? row.Ach ?? row.achievement ?? 0,
        remarks: row.remarks ?? row.Remarks ?? ""
      };
    }

    /**********************
     * 6) NAV + FILTER
     **********************/
    function bootAfterDataLoad(){
      if(!selSt){
        const allStates = [...new Set(master.map(x => normState(x.state)))];
        const hp = allStates.find(s => s === "HIMACHAL PRADESH");
        selSt = hp ? "HIMACHAL PRADESH" : (allStates[0] || "HIMACHAL PRADESH");
      }
      renderNav();
      refresh();
      updateCacheBadge();
    }

    function selectState(st){
      selSt = st;
      selSro = "ALL SROs";
      renderNav();
      refresh();
    }

    function selectSroWithAuth(sro){
      if(auth.role !== "ADMIN" && sro !== "ALL SROs"){
        alert("Only ADMIN can select specific SRO.\nLogin as ADMIN or use ALL SRO's.");
        return;
      }
      selSro = sro;
      renderNav();
      refresh();
    }

    function renderNav(){
      const container = document.getElementById("navScroll");
      const selN = normState(selSt);

      let html = "";
      for(const [zone, states] of Object.entries(nsoZones)){
        html += `<div class="zone-title">${zone}</div><div class="state-grid">`;

        states.forEach(st=>{
          const stN = normState(st);
          const hasData = master.some(x => normState(x.state) === stN);

          html += `
            <div class="st-btn ${selN===stN?'active':''} ${hasData?'has-data':''}"
                 onclick="selectState('${st.replace(/'/g,"\\'")}')">
              <div>${st}</div>
            </div>
          `;

          if(selN === stN){
            const sros = [...new Set(
              master
                .filter(x => normState(x.state) === stN)
                .map(x => normSro(x.sro))
            )].sort();

            html += `
              <div class="sub-menu-container">
                <div class="pill-grid">
                  <div class="pill all-btn ${selSro==='ALL SROs'?'active':''}"
                       onclick="event.stopPropagation(); selectSroWithAuth('ALL SROs');">
                    üåç ALL SRO's
                  </div>
                  ${sros.map(s=>`
                    <div class="pill ${normSro(selSro)===s?'active':''}"
                         onclick="event.stopPropagation(); selectSroWithAuth('${s.replace(/'/g,"\\'")}');">
                      ${s}
                    </div>
                  `).join("")}
                </div>

                <div class="month-grid">
                  ${months.map((m,i)=>`
                    <div class="pill ${selMo===i?'active':''}"
                         onclick="event.stopPropagation(); selMo=${i}; renderNav(); refresh();">
                      ${m.substring(0,3)}
                    </div>
                  `).join("")}
                </div>
              </div>
            `;
          }
        });

        html += `</div>`;
      }

      container.innerHTML = html;
    }

    function refresh(){
      const stN = normState(selSt);
      const sroN = normSro(selSro);
      const moName = months[selMo];

      filtered = master.filter(d=>{
        const matchSt = normState(d.state) === stN;
        const matchSro = (selSro === "ALL SROs") ? true : (normSro(d.sro) === sroN);
        const matchMo = String(d.month||"").trim().toLowerCase().startsWith(moName.toLowerCase().slice(0,3));
        return matchSt && matchSro && matchMo;
      });

      document.getElementById("chipState").textContent = selSt || "‚Äî";
      document.getElementById("chipSro").textContent = selSro || "‚Äî";
      document.getElementById("chipMonth").textContent = months[selMo];
      document.getElementById("chipRole").textContent = auth.role || "GUEST";

      let sumTarget = 0, sumAch = 0;
      for(const r of filtered){ sumTarget += safeNum(r.target); sumAch += safeNum(r.ach); }
      const pct = sumTarget > 0 ? (sumAch/sumTarget*100) : 0;

      document.getElementById("kpiRecords").textContent = filtered.length;
      document.getElementById("kpiTarget").textContent = fmt(sumTarget);
      document.getElementById("kpiAch").textContent = fmt(sumAch);
      document.getElementById("kpiPct").textContent = `${pct.toFixed(1)}%`;

      document.getElementById("tableHint").textContent =
        `Showing ${filtered.length} row(s) for ${selSt} | ${selSro} | ${months[selMo]}`;

      renderTable(filtered);
    }

    function fmt(n){
      try{ return Number(n||0).toLocaleString("en-IN"); }
      catch(e){ return String(n||0); }
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderTable(rows){
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");

      thead.innerHTML = `<tr>${columns.map(c=>`<th style="width:${c.w}px">${c.label}</th>`).join("")}</tr>`;

      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="${columns.length}" class="center"
          style="padding:18px;color:var(--muted);font-weight:800;">No data found for selected filters.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r=>`
        <tr>
          ${columns.map(c=>{
            let v = r[c.key];
            if(c.num) v = fmt(safeNum(v));
            return `<td class="${c.num?'right':''}" title="${String(r[c.key]??'')}">${escapeHtml(String(v ?? ""))}</td>`;
          }).join("")}
        </tr>
      `).join("");
    }

    /**********************
     * 7) EXPORT
     **********************/
    function exportCSV(){
      if(!filtered.length){ alert("No rows to export."); return; }
      const header = columns.map(c=>c.label);
      const data = filtered.map(r=>columns.map(c=>r[c.key]));
      const csv = [header, ...data].map(row => row.map(cell=>{
        const s = String(cell ?? "");
        return `"${s.replaceAll('"','""')}"`;
      }).join(",")).join("\n");
      downloadBlob(csv, `PLFS_${normState(selSt)}_${selSro}_${months[selMo]}.csv`, "text/csv;charset=utf-8;");
    }

    function exportXLSX(){
      if(!filtered.length){ alert("No rows to export."); return; }
      const aoa = [columns.map(c=>c.label), ...filtered.map(r => columns.map(c => r[c.key]))];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "PLFS");
      XLSX.writeFile(wb, `PLFS_${normState(selSt)}_${selSro}_${months[selMo]}.xlsx`);
    }

    function downloadBlob(content, filename, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 3000);
    }

    /**********************
     * 8) IMPORT
     **********************/
    function openImport(){ document.getElementById("importBackdrop").style.display="flex"; }
    function closeImport(){ document.getElementById("importBackdrop").style.display="none"; }

    function importExcel(){
      const file = document.getElementById("importFile").files[0];
      if(!file){ alert("Select a file."); return; }

      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
        master = rows.map(mapImportedRow);
        setCache(master);
        closeImport();
        bootAfterDataLoad();
      };
      reader.readAsArrayBuffer(file);
    }

    function mapImportedRow(r){
      return {
        _id: r.id || r.ID || "",
        state: r.state || r.State || r.STATE || "HIMACHAL PRADESH",
        sro: r.sro || r.SRO || r.Office || r.office || "RO SHIMLA",
        month: r.month || r.Month || r.MO || months[selMo],
        district: r.district || r.District || "",
        unit: r.unit || r.Unit || "",
        target: r.target || r.Target || 0,
        ach: r.ach || r.Ach || r.ACH || 0,
        remarks: r.remarks || r.Remarks || ""
      };
    }

    /**********************
     * 9) AUTH
     **********************/
    function openAuth(){ document.getElementById("authBackdrop").style.display="flex"; }
    function closeAuth(){ document.getElementById("authBackdrop").style.display="none"; }

    function doLogin(){
      const user = document.getElementById("authUser").value.trim();
      const pass = document.getElementById("authPass").value.trim();
      const role = document.getElementById("authRole").value.trim().toUpperCase();

      if(!user || !pass){ alert("Enter user + password."); return; }

      auth.user = user;
      auth.role = (role === "ADMIN") ? "ADMIN" : "USER";

      localStorage.setItem("PLFS_AUTH_V1", JSON.stringify(auth));
      closeAuth();
      document.getElementById("chipRole").textContent = auth.role;
    }

    function loadAuth(){
      try{
        const a = JSON.parse(localStorage.getItem("PLFS_AUTH_V1") || "{}");
        if(a && a.user) auth = a;
      }catch(e){}
      document.getElementById("chipRole").textContent = auth.role || "GUEST";
    }

    /**********************
     * 10) RESET
     **********************/
    function hardReset(){
      if(!confirm("Reset cache + filters?")) return;
      localStorage.removeItem(CACHE_KEY);
      localStorage.removeItem(CACHE_META);
      master = [];
      filtered = [];
      selSt = "";
      selSro = "ALL SROs";
      selMo = new Date().getMonth();
      renderNav();
      refresh();
      updateCacheBadge();
    }

    /**********************
     * 11) BOOT
     **********************/
    window.addEventListener("load", ()=>{
      loadAuth();
      updateCacheBadge();
      selMo = new Date().getMonth();

      const cached = getCache();
      if(cached.length){
        master = cached;
        bootAfterDataLoad();
      }else{
        selSt = "HIMACHAL PRADESH";
        renderNav();
        refresh();
      }

      autoFetch(false);
    });
  </script>
</body>
</html>