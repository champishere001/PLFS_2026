<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLFS 2026 | Field Command Center</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d1117; --sidebar: #161b22; --card: #21262d; --border: #30363d; --v1: #2ea043; --rv: #d29922; --accent: #58a6ff; --text: #c9d1d9; --text-dim: #8b949e; --urban: #1f6feb; --rural: #238636; --danger: #f85149; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 25px; font-weight: 800; font-size: 18px; color: var(--accent); border-bottom: 1px solid var(--border); text-align: center; }
        .nav-scroll { flex: 1; overflow-y: auto; padding: 10px; }
        
        .zo-item { padding: 12px; font-weight: 800; cursor: pointer; border-radius: 8px; margin-bottom: 4px; background: rgba(255,255,255,0.03); font-size: 13px; color: #fff; }
        .st-item { padding: 8px 15px 8px 25px; font-weight: 600; cursor: pointer; border-radius: 8px; font-size: 13px; color: var(--text-dim); }
        .st-item.active { color: #fff; background: rgba(88, 166, 255, 0.1); }
        .sro-item { padding: 6px 15px 6px 40px; font-size: 12px; color: var(--text-dim); cursor: pointer; border-left: 2px solid var(--border); }
        .sro-item.active { color: var(--accent); border-left-color: var(--accent); }
        
        .m-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 10px 10px 10px 40px; }
        .m-chip { font-size: 10px; text-align: center; padding: 6px 2px; border-radius: 4px; background: var(--card); border: 1px solid var(--border); cursor: pointer; color: var(--text-dim); }
        .m-chip.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #090c10; }
        .top-bar { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; background: var(--sidebar); align-items: center; }
        #searchBox { flex: 1; background: var(--bg); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 8px; font-size: 14px; outline: none; }
        
        .btn { padding: 8px 14px; border-radius: 6px; border: none; font-weight: 700; font-size: 11px; cursor: pointer; color: white; text-transform: uppercase; transition: 0.2s; }
        .btn-rural { background: var(--rural); }
        .btn-urban { background: var(--urban); }
        .btn-wipe { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-wipe:hover { background: var(--danger); color: white; }
        .btn-sync { background: var(--v1); }

        .workspace { flex: 1; padding: 25px; overflow-y: auto; }
        .v-toggle { display: flex; gap: 8px; margin-bottom: 20px; background: #161b22; padding: 5px; border-radius: 10px; width: fit-content; }
        .v-btn { padding: 10px 20px; border-radius: 8px; border: none; background: transparent; color: var(--text-dim); cursor: pointer; font-weight: 800; font-size: 11px; text-transform: uppercase; }
        .v-btn.active.v1 { background: var(--v1); color: white; }
        .v-btn.active.v2 { background: var(--rv); color: white; }

        .table-wrap { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; font-size: 11px; color: var(--text-dim); border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 13px; }
        
        .tag { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; margin-right: 5px; }
        .tag-rural { background: rgba(46, 160, 67, 0.2); color: #3fb950; border: 1px solid #2ea043; }
        .tag-urban { background: rgba(56, 139, 253, 0.2); color: #58a6ff; border: 1px solid #388bfd; }
        
        input.table-input { background: var(--bg); border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 4px; width: 100%; }
        .sync-badge { font-size: 10px; font-weight: 900; margin-left: auto; }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header">PLFS 2026</div>
    <div id="navScroll" class="nav-scroll">
        <div style="padding: 20px; color: var(--text-dim); font-size: 12px;">Initializing System...</div>
    </div>
</aside>

<main class="main">
    <header class="top-bar">
        <input type="text" id="searchBox" placeholder="Search FSU or Village..." oninput="debouncedSearch(this.value)">
        
        <button class="btn btn-rural" onclick="triggerUpload('Rural')">Upload Rural</button>
        <button class="btn btn-urban" onclick="triggerUpload('Urban')">Upload Urban</button>
        <button class="btn btn-sync" onclick="syncAllData()">Sync All</button>
        <button class="btn btn-wipe" onclick="wipeData()">Wipe Data</button>
        
        <input type="file" id="xlInput" hidden accept=".xlsx, .xls" onchange="handleFile(this)">
        <div id="syncBadge" class="sync-badge" style="color:var(--rv)">OFFLINE</div>
    </header>

    <div class="workspace">
        <div class="v-toggle">
            <button id="btnV1" class="v-btn v1 active" onclick="setVisit(1)">Visit 1 (Fresh)</button>
            <button id="btnV2" class="v-btn v2" onclick="setVisit(2)">Revisits (V2, V3, V4)</button>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">FSU / Sector</th>
                        <th style="width: 35%;">Location Detail</th>
                        <th style="width: 25%;">Enumerator</th>
                        <th style="width: 25%;">Target Date</th>
                    </tr>
                </thead>
                <tbody id="dataBody"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    const config = { 
        apiKey: "AIzaSyB6fQ8n4qyG-TfVdAqWtDped17bMYTZSgI", 
        authDomain: "action-plan-62fae.firebaseapp.com", 
        databaseURL: "https://action-plan-62fae-default-rtdb.firebaseio.com", 
        projectId: "action-plan-62fae" 
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const zones = { "North Zone": ["Delhi", "Haryana", "Himachal Pradesh", "Jammu & Kashmir", "Ladakh", "Punjab", "Rajasthan", "Uttarakhand"], "South Zone": ["Andhra Pradesh", "Karnataka", "Kerala", "Lakshadweep", "Puducherry", "Tamil Nadu", "Telangana"], "East Zone": ["Andaman & Nicobar Islands", "Bihar", "Jharkhand", "Odisha", "Sikkim", "West Bengal"], "West Zone": ["Dadra & Nagar Haveli", "Daman & Diu", "Goa", "Gujarat", "Maharashtra"], "Central Zone": ["Chhattisgarh", "Madhya Pradesh", "Uttar Pradesh"], "North-East Zone": ["Arunachal Pradesh", "Assam", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Tripura"] };
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    
    let master = [];
    let selSt = null, selSro = null, selMo = 0, selVis = 1, query = "";
    let uploadSector = 'Rural';

    function initData() {
        db.ref(`plfs_roster`).on('value', (snap) => {
            if(snap.exists()) {
                let cloudData = [];
                const val = snap.val();
                Object.keys(val).forEach(stKey => {
                    Object.values(val[stKey]).forEach(item => { if(item.uid) cloudData.push(item); });
                });
                master = cloudData;
                setStatus("SYSTEM LIVE", "var(--v1)");
                renderNav(); refresh();
            } else {
                master = [];
                renderNav(); refresh();
            }
        });
    }

    function triggerUpload(sector) {
        uploadSector = sector;
        document.getElementById('xlInput').click();
    }

    function handleFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const stateCell = sheet[XLSX.utils.encode_cell({r:6, c:0})] || sheet[XLSX.utils.encode_cell({r:6, c:1})];
            const stateName = stateCell ? stateCell.v.toString().trim() : "Unknown State";
            const rawData = XLSX.utils.sheet_to_json(sheet, { range: 7 });
            processImport(rawData, stateName);
        };
        reader.readAsArrayBuffer(file);
        input.value = '';
    }

    function processImport(data, state) {
        const newEntries = data.map((row, i) => ({
            uid: `fsu-${Date.now()}-${i}-${Math.random().toString(36).substr(2, 5)}`,
            fsu: row['FSU'] || row['FSU No'] || '0000',
            location: row['Village/Town Name'] || row['Location'] || 'N/A',
            sro: row['SRO'] || 'HQ',
            state: state,
            sector: uploadSector,
            monthIdx: selMo,
            visitNum: 1,
            enumerator: '',
            date: ''
        }));
        master = [...master, ...newEntries];
        setStatus("UNSAVED CHANGES", "var(--rv)");
        renderNav(); refresh();
    }

    async function syncAllData() {
        if(master.length === 0) return alert("No data to sync.");
        setStatus("PUSHING...", "var(--accent)");
        const grouped = {};
        master.forEach(item => { 
            if (!grouped[item.state]) grouped[item.state] = {}; 
            grouped[item.state][item.uid] = item; 
        });
        await db.ref(`plfs_roster`).set(grouped); // Use .set to ensure clean overwrite with current master
        setStatus("SYSTEM LIVE", "var(--v1)");
        alert("Cloud Sync Complete.");
    }

    async function wipeData() {
        const confirm1 = confirm("⚠️ DANGER: This will delete the entire cloud database. Are you sure?");
        if(confirm1) {
            const confirm2 = confirm("FINAL WARNING: All enumerator assignments and FSUs will be lost. Proceed?");
            if(confirm2) {
                await db.ref(`plfs_roster`).remove();
                master = [];
                setStatus("DATABASE WIPED", "var(--danger)");
                renderNav(); refresh();
            }
        }
    }

    function setStatus(txt, col) {
        const b = document.getElementById('syncBadge');
        b.innerText = txt;
        b.style.color = col;
    }

    function upd(id, k, v) { 
        let item = master.find(x => x.uid === id); 
        if(item) {
            if(k === 'en') item.enumerator = v;
            else item.date = v;
            setStatus("UNSAVED CHANGES", "var(--rv)");
        }
    }

    function renderNav() {
        const container = document.getElementById('navScroll');
        const activeStates = [...new Set(master.map(m => m.state))];
        let html = '';
        Object.keys(zones).forEach(zo => {
            if(!zones[zo].some(s => activeStates.includes(s))) return;
            html += `<div class="zo-item">${zo}</div>`;
            zones[zo].filter(s => activeStates.includes(s)).forEach(st => {
                html += `<div class="st-item ${selSt===st?'active':''}" onclick="selSt='${st}'; selSro=null; refresh(); renderNav();">${st}</div>`;
                if(selSt === st) {
                    const sros = ["ALL SROs", ...new Set(master.filter(x=>x.state===st).map(x=>x.sro))].sort();
                    sros.forEach(s => {
                        html += `<div class="sro-item ${selSro===s?'active':''}" onclick="selSro='${s}'; refresh(); renderNav(); event.stopPropagation();">${s}</div>`;
                        if(selSro === s) {
                            html += `<div class="m-grid">`;
                            months.forEach((m,i) => { html += `<div class="m-chip ${selMo===i?'active':''}" onclick="selMo=${i}; refresh(); renderNav(); event.stopPropagation();">${m}</div>`; });
                            html += `</div>`;
                        }
                    });
                }
            });
        });
        container.innerHTML = html || '<div style="padding:20px; color:var(--text-dim)">No data found. Upload Excel.</div>';
    }

    function refresh() {
        const body = document.getElementById('dataBody');
        if(!selSt || !selSro) { 
            body.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:100px; color:var(--text-dim)">Select State and SRO to view.</td></tr>'; 
            return; 
        }
        let displayData = [];
        const v1Samples = master.filter(d => d.state === selSt && (selSro === "ALL SROs" || d.sro === selSro));
        if (selVis === 1) {
            displayData = v1Samples.filter(d => parseInt(d.monthIdx) === selMo).map(item => ({ ...item, curVis: 1 }));
        } else {
            v1Samples.forEach(sample => {
                const gap = selMo - parseInt(sample.monthIdx);
                if (gap >= 1 && gap <= 3) displayData.push({ ...sample, curVis: gap + 1 });
            });
        }
        displayData = displayData.filter(d => d.fsu.toString().includes(query) || d.location.toLowerCase().includes(query.toLowerCase()));
        body.innerHTML = displayData.map(d => `
            <tr>
                <td><b style="color:#fff">${d.fsu}</b><br><span class="tag tag-${d.sector.toLowerCase()}">${d.sector}</span></td>
                <td><div style="font-weight:600">${d.location}</div><span class="tag" style="background:rgba(255,255,255,0.05)">V${d.curVis}</span><small style="color:var(--text-dim)">Start: ${months[d.monthIdx]}</small></td>
                <td><input type="text" class="table-input" value="${d.enumerator || ''}" onchange="upd('${d.uid}','en',this.value)" placeholder="Name..."></td>
                <td><input type="date" class="table-input" value="${d.date || ''}" onchange="upd('${d.uid}','dt',this.value)"></td>
            </tr>`).join('') || '<tr><td colspan="4" style="text-align:center; padding:40px;">No records.</td></tr>';
    }

    function setVisit(v) { selVis = v; document.getElementById('btnV1').classList.toggle('active', v===1); document.getElementById('btnV2').classList.toggle('active', v===2); refresh(); }
    let timer; function debouncedSearch(v) { clearTimeout(timer); timer = setTimeout(() => { query = v; refresh(); }, 300); }

    initData();
</script>
</body>
</html>
