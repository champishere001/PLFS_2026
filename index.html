<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLFS Pro - Live Hub</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --bg-glow: radial-gradient(circle at top right, #1e3a8a, #070b14);
            --pane-cream: #ffffff; 
            --primary: #2563eb;
            --accent: #00f2fe;
            --text-dark: #1e293b;
            --sidebar-width: 260px;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; 
            background: var(--bg-glow); background-attachment: fixed;
            display: flex; height: 100vh; color: var(--text-dark); overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(15px); display: flex; flex-direction: column; 
            border-right: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .brand { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand h2 { color: var(--accent); margin: 0; font-size: 20px; font-weight: 800; }

        .nav-scroll { flex: 1; overflow-y: auto; padding: 10px 0; }
        .month-header { 
            padding: 12px 20px; color: #94a3b8; cursor: pointer; display: flex; 
            justify-content: space-between; font-size: 13px; font-weight: 700;
        }
        .month-header.active { color: var(--accent); background: rgba(255,255,255,0.05); }

        .state-item { padding: 10px 20px 10px 45px; font-size: 13px; color: #64748b; cursor: pointer; transition: 0.2s; }
        .state-item.selected { color: var(--accent); background: rgba(255,255,255,0.08); font-weight: 700; }
        .national-btn { margin: 10px 20px; padding: 10px; background: var(--primary); color: white; border-radius: 6px; text-align: center; cursor: pointer; font-weight: 800; font-size: 12px; }

        /* --- MAIN --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 80px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .filter-section { background: rgba(15, 23, 42, 0.4); padding: 12px 30px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sro-grid { display: flex; gap: 8px; overflow-x: auto; flex: 1; padding-bottom: 5px; }
        .sro-pill { padding: 6px 14px; background: rgba(255,255,255,0.08); border-radius: 20px; color: #cbd5e1; cursor: pointer; font-size: 11px; white-space: nowrap; border: 1px solid rgba(255,255,255,0.1); }
        .sro-pill.active { background: var(--accent); color: #0f172a; font-weight: 700; }

        .dashboard { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
        .pane { background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .pane-fresh { width: 60%; }
        .pane-rv { width: 40%; }
        
        .header-strip { padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: 800; font-size: 13px; color: #475569; }
        .table-wrap { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 10px; color: #64748b; position: sticky; top: 0; z-index: 5; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        .search-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 8px; color: white; width: 220px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; font-size: 12px; }

        #loadingOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: var(--accent); }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,242,254,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div><p id="loadText">PROCESSING DATA...</p></div>

<aside class="sidebar">
    <div class="brand"><h2>PLFS PRO</h2></div>
    <div class="national-btn" onclick="selectNationalView()">üåê NATIONAL VIEW (ALL)</div>
    <div class="nav-scroll" id="navContainer"></div>
</aside>

<div class="main">
    <header class="top-bar">
        <div>
            <h3 id="viewTitle" style="color:white; margin:0;">Hub Ready</h3>
            <div id="breadcrumb" style="font-size: 11px; color: var(--accent);">Import Excel to populate data</div>
        </div>
        <div style="flex: 1; display: flex; justify-content: center;">
            <div style="background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 30px; color: white; font-size: 12px; border: 1px solid rgba(255,255,255,0.2);">
                Loaded: <span id="recordCount" style="font-weight: 800; color: var(--accent);">0</span> Records
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn" style="background: #f59e0b; color: white;" onclick="document.getElementById('fileInput').click()">üì§ Import Excel</button>
            <input type="file" id="fileInput" multiple style="display:none" onchange="uploadFiles(this)">
            <button class="btn" style="background: #10b981; color: white;" onclick="saveToCloud()">‚òÅÔ∏è Sync to Firebase</button>
        </div>
    </header>

    <div class="filter-section">
        <div class="sro-grid" id="sroContainer"></div>
        <input type="text" class="search-box" id="globalSearch" placeholder="üîç Search FSU or Village..." oninput="applyFilters()">
    </div>

    <div class="dashboard">
        <section class="pane pane-fresh">
            <div class="header-strip">FRESH VISITS (R1)</div>
            <div class="table-wrap"><table><thead><tr><th>FSU Details</th><th>Village/Town</th><th>Enumerator</th><th>Field Dates</th><th>Action</th></tr></thead><tbody id="freshBody"></tbody></table></div>
        </section>
        <section class="pane pane-rv">
            <div class="header-strip">REVISITS (R2-R4)</div>
            <div class="table-wrap"><table><thead><tr><th>UID</th><th>Enumerator</th><th>Collection Date</th><th>Action</th></tr></thead><tbody id="rvBody"></tbody></table></div>
        </section>
    </div>
</div>

<script>
    // --- FIREBASE INITIALIZATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyB6fQ8n4qyG-TfVdAqWtDped17bMYTZSgI",
        authDomain: "action-plan-62fae.firebaseapp.com",
        databaseURL: "https://action-plan-62fae-default-rtdb.firebaseio.com",
        projectId: "action-plan-62fae"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const statesList = ["Himachal", "Punjab", "Haryana", "Delhi"];
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    let masterData = []; // Entirely populated by Import or DB
    let selectedMonth = new Date().getMonth();
    let currentScope = 'NATIONAL'; 
    let currentSro = 'ALL';

    window.onload = () => {
        renderSidebar();
        selectNationalView(); // Initialize with data from Firebase
    };

    function renderSidebar() {
        const container = document.getElementById('navContainer');
        container.innerHTML = "";
        months.forEach((m, idx) => {
            const isActive = (idx === selectedMonth);
            container.innerHTML += `
                <div class="month-group">
                    <div class="month-header ${isActive ? 'active' : ''}" onclick="selectedMonth=${idx}; renderSidebar(); applyFilters();">
                        ${m.toUpperCase()} <span>${isActive ? '‚ñæ' : '‚ñ∏'}</span>
                    </div>
                    <div style="display: ${isActive ? 'block' : 'none'}">
                        ${statesList.map(s => `<div class="state-item ${currentScope === s ? 'selected' : ''}" onclick="selectState('${s}')">${s}</div>`).join('')}
                    </div>
                </div>`;
        });
    }

    async function selectState(state) {
        currentScope = state;
        currentSro = 'ALL';
        document.getElementById('viewTitle').innerText = `${state} View`;
        document.getElementById('breadcrumb').innerText = `Managing roster for ${state}`;
        renderSidebar();
        await loadFromFirebase(state);
    }

    async function selectNationalView() {
        currentScope = 'NATIONAL';
        currentSro = 'ALL';
        document.getElementById('viewTitle').innerText = `National View`;
        document.getElementById('breadcrumb').innerText = `Viewing all states combined`;
        renderSidebar();
        
        document.getElementById('loadingOverlay').style.display = 'flex';
        masterData = [];
        for (let s of statesList) {
            const snap = await database.ref(`plfs_roster/${s}`).once('value');
            if(snap.exists()) {
                const data = Object.values(snap.val());
                masterData.push(...data);
            }
        }
        document.getElementById('loadingOverlay').style.display = 'none';
        updateSroPills();
        applyFilters();
    }

    async function loadFromFirebase(state) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        const snap = await database.ref(`plfs_roster/${state}`).once('value');
        masterData = snap.exists() ? Object.values(snap.val()) : [];
        document.getElementById('loadingOverlay').style.display = 'none';
        updateSroPills();
        applyFilters();
    }

    function updateSroPills() {
        const container = document.getElementById('sroContainer');
        // Get unique SROs from the currently loaded masterData
        const relevantData = currentScope === 'NATIONAL' ? masterData : masterData.filter(d => d.state === currentScope);
        const sros = [...new Set(relevantData.map(d => d.sro))].filter(Boolean).sort();
        
        let html = `<div class="sro-pill ${currentSro === 'ALL' ? 'active' : ''}" onclick="currentSro='ALL'; updateSroPills(); applyFilters();">ALL SROs</div>`;
        sros.forEach(s => {
            html += `<div class="sro-pill ${currentSro === s ? 'active' : ''}" onclick="currentSro='${s}'; updateSroPills(); applyFilters();">${s}</div>`;
        });
        container.innerHTML = html;
        document.getElementById('recordCount').innerText = masterData.length;
    }

    function applyFilters() {
        const query = document.getElementById('globalSearch').value.toLowerCase();
        const filtered = masterData.filter(d => {
            const matchMonth = d.monthIdx === selectedMonth;
            const matchScope = currentScope === 'NATIONAL' || d.state === currentScope;
            const matchSro = currentSro === 'ALL' || d.sro === currentSro;
            const matchSearch = String(d.fsu).includes(query) || d.village.toLowerCase().includes(query);
            return matchMonth && matchScope && matchSro && matchSearch;
        });
        renderTables(filtered);
    }

    function renderTables(data) {
        const fBody = document.getElementById('freshBody'); 
        const rBody = document.getElementById('rvBody');
        fBody.innerHTML = rBody.innerHTML = "";
        
        data.forEach(d => {
            if (d.visit === 1) {
                fBody.innerHTML += `<tr>
                    <td><b>${d.fsu}</b><br><small style="color:#2563eb">${d.sro} | ${d.state}</small></td>
                    <td>${d.village}</td>
                    <td><input type="text" value="${d.enumerator || ''}" placeholder="Assign..." onchange="updateVal('${d.uid}', 'enumerator', this.value)"></td>
                    <td><input type="date" value="${d.startDate || ''}" onchange="updateVal('${d.uid}', 'startDate', this.value)"></td>
                    <td><button style="background:none; border:none; cursor:pointer;" onclick="del('${d.uid}')">üóëÔ∏è</button></td>
                </tr>`;
            } else {
                rBody.innerHTML += `<tr>
                    <td><b>${d.uid}</b><br><small>${d.sro}</small></td>
                    <td style="color:#2563eb; font-weight:600;">${d.enumerator || 'Not Assigned'}</td>
                    <td><input type="date" value="${d.collectionDate || ''}" onchange="updateVal('${d.uid}', 'collectionDate', this.value)"></td>
                    <td><button style="background:none; border:none; cursor:pointer;" onclick="del('${d.uid}')">üóëÔ∏è</button></td>
                </tr>`;
            }
        });
    }

    function updateVal(uid, key, val) {
        const item = masterData.find(d => d.uid === uid);
        if (item) {
            item[key] = val;
            // Auto-propagate enumerator name to revisits
            if (key === 'enumerator' && item.visit === 1) {
                masterData.filter(x => x.fsu === item.fsu).forEach(x => x.enumerator = val);
                applyFilters();
            }
        }
    }

    async function uploadFiles(input) {
        if (currentScope === 'NATIONAL') return alert("Please select a specific STATE from the sidebar before importing.");
        
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadText').innerText = "PARSING EXCEL DATA...";

        for (let file of input.files) {
            const buffer = await file.arrayBuffer();
            const workbook = XLSX.read(buffer);
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(sheet, {range: 7});

            raw.forEach(r => {
                if (!r.FSU) return;
                
                // Identify SRO column dynamically
                const sroRaw = r['SRO [Code]'] || r['SRO'] || r['Sub Regional Office'] || 'Unknown';
                const sro = String(sroRaw).replace(/\[.*?\]/g, "").trim();
                
                // Identify Month column
                const monthStr = String(r['Month [Qtr]'] || r['Month'] || "1");
                const baseMonth = (parseInt(monthStr.match(/\d+/)) - 1) % 12;

                for (let v = 1; v <= 4; v++) {
                    const uid = `${r.FSU}-V${v}`;
                    // Check if record exists, if not, add it
                    if (!masterData.find(m => m.uid === uid)) {
                        masterData.push({ 
                            uid, 
                            fsu: r.FSU, 
                            visit: v, 
                            sro, 
                            state: currentScope,
                            monthIdx: (baseMonth + (v - 1)) % 12, 
                            village: (r['Village[Code]'] || r['Town [Code]'] || r['Village Name'] || 'N/A').toString(),
                            enumerator: "", 
                            startDate: "", 
                            collectionDate: "" 
                        });
                    }
                }
            });
        }
        document.getElementById('loadingOverlay').style.display = 'none';
        updateSroPills(); 
        applyFilters();
    }

    async function saveToCloud() {
        if(currentScope === 'NATIONAL') return alert("Select a specific state to sync.");
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadText').innerText = "UPLOADING TO CLOUD...";
        
        const stateData = masterData.filter(d => d.state === currentScope);
        const dataObj = {};
        stateData.forEach(item => dataObj[item.uid] = item);

        try { 
            await database.ref(`plfs_roster/${currentScope}`).set(dataObj); 
            alert(`${currentScope} data synced successfully!`); 
        } catch (e) { 
            alert("Sync Failed: " + e.message); 
        }
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function del(uid) { 
        if(confirm("Delete this entry?")) {
            masterData = masterData.filter(d => d.uid !== uid); 
            applyFilters(); 
            updateSroPills();
        }
    }
</script>
</body>
</html>
